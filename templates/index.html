
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotionSync - ä½å§¿æå–ä¸åŠ¨ä½œä¼°è®¡è½¯ä»¶</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .content {
            padding: 20px;
        }
        .tab-container {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 5px;
        }
        .tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-size: 13px;
            white-space: nowrap;
        }
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }
        .tab-group {
            display: flex;
            gap: 0;
            border-right: 1px solid #ddd;
            padding-right: 10px;
            margin-right: 10px;
        }
        .tab-group:last-child {
            border-right: none;
            margin-right: 0;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn:hover {
            background: #5a6fd8;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .dataset-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }
        .info-card h3 {
            margin: 0 0 10px 0;
            color: #667eea;
        }
        .info-card p {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ MotionSync</h1>
            <p>ä½å§¿æå–ä¸åŠ¨ä½œä¼°è®¡è½¯ä»¶ - Webç‰ˆæœ¬</p>
        </div>
        
        <div class="content">
            <div class="tab-container">
                <div class="tab-group">
                    <div class="tab active" onclick="showTab('auto-label')">ä½å§¿æå–</div>
                    <div class="tab" onclick="showTab('convert')">æ ¼å¼è½¬æ¢</div>
                    <div class="tab" onclick="showTab('validate')">JSONéªŒè¯</div>
                    <div class="tab" onclick="showTab('dataset')">æ•°æ®é›†ä¿¡æ¯</div>
                </div>
                <div class="tab-group">
                    <div class="tab" onclick="showTab('video_action')">è§†é¢‘æ ‡æ³¨</div>
                    <div class="tab" onclick="showTab('realtime_action')">å®æ—¶æ ‡æ³¨</div>
                </div>
                <div class="tab-group">
                    <div class="tab" onclick="showTab('action_training')">æ¨¡å‹è®­ç»ƒ</div>
                    <div class="tab" onclick="showTab('pose3d')">åŠ¨ä½œè¯†åˆ«</div>
                </div>
                <div class="tab-group">
                    <div class="tab" onclick="showTab('coco')">COCOå·¥å…·</div>
                    <div class="tab" onclick="showTab('logs')">è¿è¡Œæ—¥å¿—</div>
                </div>
            </div>
            
            <!-- ä½å§¿æå–æ ‡ç­¾é¡µ -->
            <div id="auto-label" class="tab-content active">
                <h2>ä½å§¿æå–</h2>
                <div class="form-group">
                    <label>å›¾ç‰‡ç›®å½•:</label>
                    <input type="text" id="img_dir" value="./datasets/images/train">
                </div>
                <div class="form-group">
                    <label>æ¨¡å‹è·¯å¾„:</label>
                    <input type="text" id="model_path" value="./models/yolov8n-pose.pt">
                </div>
                <div class="form-group">
                    <label>è¾“å‡ºç›®å½•:</label>
                    <input type="text" id="output_dir" value="./datasets/labels/train">
                </div>
                <div class="form-group">
                    <label>ç½®ä¿¡åº¦é˜ˆå€¼:</label>
                    <input type="number" id="conf_threshold" value="0.5" min="0.1" max="1.0" step="0.1">
                </div>
                <button class="btn" onclick="startAutoLabel()">å¼€å§‹ä½å§¿æå–</button>
                <div class="progress" id="progress" style="display: none;">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div id="status"></div>
            </div>
            
            <!-- æ ¼å¼è½¬æ¢æ ‡ç­¾é¡µ -->
            <div id="convert" class="tab-content">
                <h2>æ ¼å¼è½¬æ¢</h2>
                <div class="form-group">
                    <label>è½¬æ¢ç±»å‹:</label>
                    <select id="convert_mode">
                        <option value="txt2coco">TXT â†’ COCO JSON</option>
                        <option value="coco2txt">COCO JSON â†’ TXT</option>
                        <option value="txt2labelme">TXT â†’ LabelMe JSON</option>
                        <option value="labelme2txt">LabelMe JSON â†’ TXT</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è¾“å…¥è·¯å¾„:</label>
                    <input type="text" id="input_path" value="./datasets/labels/train">
                </div>
                <div class="form-group">
                    <label>è¾“å‡ºè·¯å¾„:</label>
                    <input type="text" id="output_path" value="./datasets/labels_json/1.json">
                </div>
                <div class="form-group">
                    <label>å›¾ç‰‡ç›®å½•:</label>
                    <input type="text" id="convert_img_dir" value="./datasets/images/train">
                </div>
                <button class="btn" onclick="startConvert()">å¼€å§‹è½¬æ¢</button>
                <div class="progress" id="convert-progress" style="display: none;">
                    <div class="progress-bar" id="convert-progress-bar"></div>
                </div>
                <div id="convert-status"></div>
            </div>
            
            <!-- JSONéªŒè¯æ ‡ç­¾é¡µ -->
            <div id="validate" class="tab-content">
                <h2>JSONéªŒè¯ä¸å¯è§†åŒ–</h2>
                <div class="form-group">
                    <label>JSONæ–‡ä»¶è·¯å¾„:</label>
                    <input type="text" id="json_path" placeholder="è¾“å…¥JSONæ–‡ä»¶è·¯å¾„">
                </div>
                <button class="btn" onclick="validateJson()">éªŒè¯JSON</button>
                <button class="btn" onclick="visualizeJson()">å¯è§†åŒ–å…³é”®ç‚¹</button>
                
                <div id="validation-result" style="margin-top: 20px;"></div>
                
                <div id="visualization-section" style="margin-top: 20px; display: none;">
                    <h3>å…³é”®ç‚¹å¯è§†åŒ–</h3>
                    <div class="form-group">
                        <label>å›¾ç‰‡ç´¢å¼•:</label>
                        <input type="number" id="image_index" value="0" min="0">
                    </div>
                    <div id="keypoints-display"></div>
                </div>
            </div>
            
            <!-- COCO Annotatoræ ‡ç­¾é¡µ -->
            <div id="coco" class="tab-content">
                <h2>COCO Annotatorç®¡ç†</h2>
                <div class="info-card">
                    <h3>COCO AnnotatorçŠ¶æ€</h3>
                    <p id="coco-status">æ£€æŸ¥ä¸­...</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <button class="btn" onclick="checkCocoStatus()">æ£€æŸ¥çŠ¶æ€</button>
                    <button class="btn" onclick="startCocoAnnotator()">å¯åŠ¨COCO Annotator</button>
                    <button class="btn" onclick="stopCocoAnnotator()">åœæ­¢COCO Annotator</button>
                    <button class="btn" onclick="openCocoAnnotator()" id="open-coco-btn" style="display: none;">æ‰“å¼€COCO Annotator</button>
                </div>
                
                <div id="coco-message" style="margin-top: 20px;"></div>
                
                <div class="info-card" style="margin-top: 20px;">
                    <h3>ä½¿ç”¨è¯´æ˜</h3>
                    <p>1. ç‚¹å‡»"å¯åŠ¨COCO Annotator"å¯åŠ¨æœåŠ¡</p>
                    <p>2. ç­‰å¾…å¯åŠ¨å®Œæˆåï¼Œç‚¹å‡»"æ‰“å¼€COCO Annotator"</p>
                    <p>3. åœ¨COCO Annotatorä¸­éªŒè¯å’Œä¿®æ”¹JSONæ–‡ä»¶</p>
                    <p>4. å®Œæˆåå¯ä»¥åœæ­¢æœåŠ¡é‡Šæ”¾èµ„æº</p>
                </div>
            </div>
            
            <!-- æ•°æ®é›†ä¿¡æ¯æ ‡ç­¾é¡µ -->
            <div id="dataset" class="tab-content">
                <h2>æ•°æ®é›†ä¿¡æ¯</h2>
                <button class="btn" onclick="loadDatasetInfo()">åˆ·æ–°ä¿¡æ¯</button>
                <div class="dataset-info" id="dataset-info">
                    <!-- æ•°æ®é›†ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <!-- è¿è¡Œæ—¥å¿—æ ‡ç­¾é¡µ -->
            <div id="logs" class="tab-content">
                <h2>è¿è¡Œæ—¥å¿—</h2>
                <button class="btn" onclick="loadLogs()">åˆ·æ–°æ—¥å¿—</button>
                <button class="btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                <div class="log-container" id="log-container">
                    <!-- æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
            
            <!-- 3Dç«æŸ´äººæ ‡ç­¾é¡µ -->
            <div id="pose3d" class="tab-content">
                <h2>3Dç«æŸ´äººï¼ˆå®æ—¶ï¼‰</h2>
                <div class="form-group">
                    <label>è§†é¢‘è·¯å¾„:</label>
                    <input type="text" id="video_path" placeholder="ä¾‹å¦‚: ./datasets/videos/demo.mp4 æˆ– ./1.mp4">
                    <button class="btn" onclick="loadVideoFrame()" style="margin-top: 5px;">åŠ è½½ç¬¬ä¸€å¸§å¹¶é€‰æ‹©ROI</button>
                </div>
                <div class="form-group">
                    <label>ROIåŒºåŸŸ:</label>
                    <input type="text" id="pose_roi" placeholder="å°†åœ¨ç¬¬ä¸€å¸§ä¸Šé€‰æ‹©ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥ x,y,w,h">
                    <div id="roi_canvas_container" style="margin-top: 10px; display: none;">
                        <canvas id="roi_canvas" style="border: 1px solid #ddd; max-width: 100%; cursor: crosshair;"></canvas>
                        <div style="margin-top: 5px;">
                            <button class="btn" onclick="confirmROI()">ç¡®è®¤ROI</button>
                            <button class="btn" onclick="cancelROISelection()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>æ¨¡å‹è·¯å¾„:</label>
                    <input type="text" id="pose_model_path" value="./models/yolov8n-pose.pt">
                </div>
                <div class="form-group">
                    <label>ç½®ä¿¡åº¦é˜ˆå€¼:</label>
                    <input type="number" id="pose_conf" value="0.5" min="0.1" max="1.0" step="0.1">
                </div>
                <div class="form-group">
                    <label>ç¼©æ”¾æ¯”ä¾‹:</label>
                    <input type="number" id="pose_scale" value="1.0" min="0.1" max="3.0" step="0.1">
                </div>
                <div class="form-group">
                    <label>æ’­æ”¾é€Ÿåº¦:</label>
                    <input type="number" id="pose_speed" value="1.0" min="0.1" max="5.0" step="0.1">
                    <small style="color: #666;">1.0=æ­£å¸¸é€Ÿåº¦ï¼Œ2.0=2å€é€Ÿï¼Œ0.5=0.5å€é€Ÿ</small>
                </div>
                <button class="btn" onclick="startPoseStream()">å¼€å§‹</button>
                <button class="btn" onclick="stopPoseStream()">åœæ­¢</button>

                <div id="pose_status" style="margin-top: 10px;"></div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <h3>è§†é¢‘æµ</h3>
                        <img id="video_frame" style="width: 100%; background: #111; border-radius: 8px; display: none;">
                        <div id="video_placeholder" style="width: 100%; height: 360px; background: #111; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666;">
                            ç­‰å¾…è§†é¢‘æµ...
                        </div>
                    </div>
                    <div>
                        <h3>3Dç«æŸ´äºº</h3>
                        <div id="three-container" style="width: 100%; height: 360px; background: #111; border-radius: 8px;"></div>
                    </div>
                </div>
                
                <div style="margin-top: 10px; color:#666;">
                    æç¤ºï¼šç‚¹å‡»"åŠ è½½ç¬¬ä¸€å¸§å¹¶é€‰æ‹©ROI"å¯åœ¨è§†é¢‘ç¬¬ä¸€å¸§ä¸Šæ‹–æ‹½é€‰æ‹©æ„Ÿå…´è¶£åŒºåŸŸã€‚3Dç«æŸ´äººå®æ—¶æ˜¾ç¤ºå…³é”®ç‚¹ï¼Œå¯æ‹–æ‹½æ—‹è½¬æŸ¥çœ‹ä¸åŒè§’åº¦ã€‚
                </div>
            </div>
            
            <!-- è§†é¢‘åŠ¨ä½œæ ‡æ³¨æ ‡ç­¾é¡µ -->
            <div id="video_action" class="tab-content">
                <h2>è§†é¢‘åŠ¨ä½œæ ‡æ³¨</h2>
                <div class="info-card" style="margin-bottom: 20px;">
                    <h3>ä½¿ç”¨è¯´æ˜</h3>
                    <p>1. é€‰æ‹©è§†é¢‘æ–‡ä»¶å¹¶è®¾ç½®å‚æ•°</p>
                    <p>2. ç‚¹å‡»"å¼€å§‹æå–å…³é”®ç‚¹"æå–poseæ•°æ®</p>
                    <p>3. åœ¨è§†é¢‘æ’­æ”¾ç•Œé¢ä½¿ç”¨æŒ‰é’®æˆ–é”®ç›˜æ ‡æ³¨åŠ¨ä½œï¼šW(å‰è¿›) A(å·¦) S(åé€€) D(å³) ç©ºæ ¼(è·³è·ƒ) I(é™æ­¢)</p>
                    <p>4. <strong>æ ‡æ³¨è¦†ç›–å¸§æ•°</strong>ï¼šè®¾ç½®ä¸º1æ—¶é€å¸§æ ‡æ³¨ï¼Œ>1æ—¶æ‰¹é‡æ ‡æ³¨ï¼ˆä¾‹å¦‚è®¾ç½®ä¸º5ï¼Œåˆ™æ¯5å¸§æ ‡æ³¨ä¸€æ¬¡ï¼‰</p>
                    <p>5. æ ‡æ³¨å®Œæˆåç‚¹å‡»"ä¿å­˜æ ‡æ³¨"</p>
                </div>
                
                <div class="form-group">
                    <label>è§†é¢‘è·¯å¾„:</label>
                    <input type="text" id="video_action_path" placeholder="ä¾‹å¦‚: ./1.mp4">
                </div>
                <div class="form-group">
                    <label>æ¨¡å‹è·¯å¾„:</label>
                    <input type="text" id="video_action_model" value="./models/yolov8n-pose.pt">
                </div>
                <div class="form-group">
                    <label>è¾“å‡ºJSONè·¯å¾„:</label>
                    <input type="text" id="video_action_output" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ">
                </div>
                <div class="form-group">
                    <label>ç½®ä¿¡åº¦é˜ˆå€¼:</label>
                    <input type="number" id="video_action_conf" value="0.5" min="0.1" max="1.0" step="0.1">
                </div>
                <div class="form-group">
                    <label>åºåˆ—é•¿åº¦:</label>
                    <input type="number" id="video_action_seq_len" value="30" min="10" max="100">
                    <small style="color: #666;">æ¯æ¬¡æ ‡æ³¨çš„æŒç»­æ—¶é—´ï¼ˆå¸§æ•°ï¼‰</small>
                </div>
                <div class="form-group">
                    <label>æ ‡æ³¨è¦†ç›–å¸§æ•°:</label>
                    <input type="number" id="video_action_label_frames" value="1" min="1" max="50">
                    <small style="color: #666;">æ¯æ¬¡æ ‡æ³¨è¦†ç›–å¤šå°‘å¸§ï¼ˆ1=é€å¸§æ ‡æ³¨ï¼Œ>1=æ‰¹é‡æ ‡æ³¨ï¼‰</small>
                </div>
                <div class="form-group">
                    <label>ROIåŒºåŸŸ (å¯é€‰):</label>
                    <input type="text" id="video_action_roi" placeholder="æ ¼å¼: x,y,w,h">
                </div>
                
                <button class="btn" onclick="startVideoActionLabeling()">å¼€å§‹æå–å…³é”®ç‚¹</button>
                <button class="btn" onclick="saveVideoAnnotation()" id="save_video_annotation_btn" style="display: none;">ä¿å­˜æ ‡æ³¨</button>
                
                <div id="video_action_status" style="margin-top: 10px;"></div>
                
                <div id="video_action_player" style="margin-top: 20px; display: none;">
                    <h3>è§†é¢‘æ’­æ”¾ä¸æ ‡æ³¨</h3>
                    <div style="position: relative; background: #000; border-radius: 8px; overflow: hidden;">
                        <canvas id="video_action_canvas" style="width: 100%; max-width: 800px; display: block;"></canvas>
                        <div style="padding: 10px; background: rgba(0,0,0,0.7); color: white;">
                            <div>å½“å‰å¸§: <span id="video_action_frame">0</span> / <span id="video_action_total_frames">0</span></div>
                            <div>å½“å‰åŠ¨ä½œ: <span id="video_action_current_action">æœªæ ‡æ³¨</span></div>
                            <div style="margin-top: 10px;">
                                <button class="btn" onclick="videoActionPlayPause()">æ’­æ”¾/æš‚åœ</button>
                                <button class="btn" onclick="videoActionPrevFrame()">ä¸Šä¸€å¸§</button>
                                <button class="btn" onclick="videoActionNextFrame()">ä¸‹ä¸€å¸§</button>
                                <button class="btn" onclick="videoActionLabel('w')">W-å‰è¿›</button>
                                <button class="btn" onclick="videoActionLabel('a')">A-å·¦</button>
                                <button class="btn" onclick="videoActionLabel('s')">S-åé€€</button>
                                <button class="btn" onclick="videoActionLabel('d')">D-å³</button>
                                <button class="btn" onclick="videoActionLabel(' ')">ç©ºæ ¼-è·³è·ƒ</button>
                                <button class="btn" onclick="videoActionLabel('idle')">I-é™æ­¢</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å®æ—¶æ¸¸æˆæ ‡æ³¨æ ‡ç­¾é¡µ -->
            <div id="realtime_action" class="tab-content">
                <h2>å®æ—¶æ¸¸æˆç”»é¢æ ‡æ³¨</h2>
                <div class="info-card" style="margin-bottom: 20px; background: #fff3cd; border-color: #ffc107;">
                    <h3>âš ï¸ é‡è¦æç¤º</h3>
                    <p>1. æ­¤åŠŸèƒ½éœ€è¦å®‰è£…é¢å¤–ä¾èµ–: <code>pip install mss pynput</code></p>
                    <p>2. åœ¨Linuxä¸Šå¯èƒ½éœ€è¦sudoæƒé™è¿è¡Œï¼ˆç”¨äºé”®ç›˜ç›‘å¬ï¼‰</p>
                    <p>3. å¯åŠ¨åè¯·åœ¨3ç§’å†…åˆ‡æ¢åˆ°æ¸¸æˆçª—å£</p>
                    <p>4. æŒ‰ä½W/A/S/D/ç©ºæ ¼è¿›è¡ŒåŠ¨ä½œï¼Œç³»ç»Ÿè‡ªåŠ¨æ ‡æ³¨</p>
                    <p>5. æŒ‰ESCé”®åœæ­¢æ ‡æ³¨å¹¶ä¿å­˜</p>
                </div>
                
                <div class="form-group">
                    <label>æ¨¡å‹è·¯å¾„:</label>
                    <input type="text" id="realtime_action_model" value="./models/yolov8n-pose.pt">
                </div>
                <div class="form-group">
                    <label>å±å¹•åŒºåŸŸ (å¯é€‰):</label>
                    <input type="text" id="realtime_action_monitor" placeholder="æ ¼å¼: x,y,width,height (ç•™ç©ºåˆ™å…¨å±)">
                    <small style="color: #666;">ä¾‹å¦‚: 0,0,1920,1080</small>
                </div>
                <div class="form-group">
                    <label>ç½®ä¿¡åº¦é˜ˆå€¼:</label>
                    <input type="number" id="realtime_action_conf" value="0.5" min="0.1" max="1.0" step="0.1">
                </div>
                <div class="form-group">
                    <label>æ•è·å¸§ç‡:</label>
                    <input type="number" id="realtime_action_fps" value="30" min="10" max="60">
                </div>
                <div class="form-group">
                    <label>è¾“å‡ºJSONè·¯å¾„ (å¯é€‰):</label>
                    <input type="text" id="realtime_action_output" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ">
                </div>
                <div class="form-group">
                    <label>åºåˆ—é•¿åº¦:</label>
                    <input type="number" id="realtime_action_seq_len" value="30" min="10" max="100">
                </div>
                
                <button class="btn" onclick="startRealtimeLabeling()">å¼€å§‹å®æ—¶æ ‡æ³¨</button>
                <button class="btn" onclick="stopRealtimeLabeling()" id="stop_realtime_btn" style="display: none;">åœæ­¢æ ‡æ³¨</button>
                
                <div id="realtime_action_status" style="margin-top: 10px;"></div>
                
                <div id="realtime_action_preview" style="margin-top: 20px; display: none;">
                    <h3>å®æ—¶é¢„è§ˆ</h3>
                    <div style="position: relative; background: #000; border-radius: 8px; overflow: hidden;">
                        <div id="realtime_action_display" style="width: 100%; max-width: 800px; height: 450px; background: #111; display: flex; align-items: center; justify-content: center; color: #666;">
                            å®æ—¶ç”»é¢å°†åœ¨è¿™é‡Œæ˜¾ç¤º
                        </div>
                        <div style="padding: 10px; background: rgba(0,0,0,0.7); color: white;">
                            <div>çŠ¶æ€: <span id="realtime_action_state">è¿è¡Œä¸­</span></div>
                            <div>å½“å‰åŠ¨ä½œ: <span id="realtime_action_current">ç­‰å¾…é”®ç›˜è¾“å…¥</span></div>
                            <div style="margin-top: 5px; font-size: 12px;">
                                æç¤º: æŒ‰ä½W/A/S/D/ç©ºæ ¼è¿›è¡Œæ ‡æ³¨ï¼ŒæŒ‰ESCåœæ­¢
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- åŠ¨ä½œåˆ†ç±»è®­ç»ƒæ ‡ç­¾é¡µ -->
            <div id="action_training" class="tab-content">
                <h2>åŠ¨ä½œåˆ†ç±»æ¨¡å‹è®­ç»ƒ</h2>
                <div class="info-card" style="margin-bottom: 20px;">
                    <h3>ä½¿ç”¨è¯´æ˜</h3>
                    <p>1. é€‰æ‹©æ ‡æ³¨æ•°æ®ç›®å½•ï¼ˆåŒ…å«å¤šä¸ªaction_labels.jsonæ–‡ä»¶ï¼‰æˆ–å•ä¸ªJSONæ–‡ä»¶</p>
                    <p>2. è®¾ç½®è®­ç»ƒå‚æ•°</p>
                    <p>3. ç‚¹å‡»"å¼€å§‹è®­ç»ƒ"è®­ç»ƒåŠ¨ä½œåˆ†ç±»æ¨¡å‹</p>
                    <p>4. è®­ç»ƒå®Œæˆåå¯ä»¥åœ¨"åŠ¨ä½œè¯†åˆ«"æ ‡ç­¾é¡µä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>æ•°æ®è®¾ç½®</h3>
                        <div class="form-group">
                            <label>æ ‡æ³¨æ•°æ®è·¯å¾„:</label>
                            <input type="text" id="training_data_path" placeholder="ä¾‹å¦‚: ./action_labels/ æˆ– ./1_action_labels.json">
                            <small style="color: #666;">å¯ä»¥æ˜¯åŒ…å«å¤šä¸ªJSONæ–‡ä»¶çš„ç›®å½•ï¼Œæˆ–å•ä¸ªJSONæ–‡ä»¶</small>
                        </div>
                        <div class="form-group">
                            <label>è¾“å‡ºç›®å½•:</label>
                            <input type="text" id="training_output" value="./models/action_classifier">
                        </div>
                    </div>
                    
                    <div>
                        <h3>æ¨¡å‹å‚æ•°</h3>
                        <div class="form-group">
                            <label>æ¨¡å‹ç±»å‹:</label>
                            <select id="training_model_type">
                                <option value="lstm" selected>LSTMï¼ˆæ¨èï¼‰</option>
                                <option value="gru">GRUï¼ˆè½»é‡ï¼‰</option>
                                <option value="transformer">Transformerï¼ˆå¼ºå¤§ï¼‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>åºåˆ—é•¿åº¦:</label>
                            <input type="number" id="training_seq_len" value="30" min="10" max="100">
                        </div>
                        <div class="form-group">
                            <label>éšè—å±‚ç»´åº¦:</label>
                            <input type="number" id="training_hidden_dim" value="128" min="32" max="512">
                        </div>
                        <div class="form-group">
                            <label>å±‚æ•°:</label>
                            <input type="number" id="training_num_layers" value="2" min="1" max="5">
                        </div>
                    </div>
                    
                    <div>
                        <h3>è®­ç»ƒå‚æ•°</h3>
                        <div class="form-group">
                            <label>æ‰¹æ¬¡å¤§å°:</label>
                            <input type="number" id="training_batch_size" value="32" min="8" max="128">
                        </div>
                        <div class="form-group">
                            <label>è®­ç»ƒè½®æ•°:</label>
                            <input type="number" id="training_epochs" value="50" min="10" max="200">
                        </div>
                        <div class="form-group">
                            <label>å­¦ä¹ ç‡:</label>
                            <input type="number" id="training_lr" value="0.001" min="0.0001" max="0.01" step="0.0001">
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="startActionTraining()">å¼€å§‹è®­ç»ƒ</button>
                    <button class="btn" onclick="stopActionTraining()" id="stop_training_btn" style="display: none;">åœæ­¢è®­ç»ƒ</button>
                </div>
                
                <div id="training_status" style="margin-top: 10px;"></div>
                
                <div id="training_progress" style="margin-top: 20px; display: none;">
                    <h3>è®­ç»ƒè¿›åº¦</h3>
                    <div class="progress">
                        <div class="progress-bar" id="training_progress_bar" style="width: 0%;"></div>
                    </div>
                    <div id="training_logs" class="log-container" style="height: 200px; margin-top: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script>
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        function startAutoLabel() {
            const data = {
                img_dir: document.getElementById('img_dir').value,
                model_path: document.getElementById('model_path').value,
                output_dir: document.getElementById('output_dir').value,
                conf_threshold: parseFloat(document.getElementById('conf_threshold').value)
            };
            
            fetch('/api/auto_label', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showStatus('error', data.error);
                } else {
                    showStatus('info', data.message);
                    document.getElementById('progress').style.display = 'block';
                    pollStatus();
                }
            })
            .catch(error => {
                showStatus('error', 'è¯·æ±‚å¤±è´¥: ' + error);
            });
        }
        
        function startConvert() {
            const data = {
                mode: document.getElementById('convert_mode').value,
                input_path: document.getElementById('input_path').value,
                output_path: document.getElementById('output_path').value,
                img_dir: document.getElementById('convert_img_dir').value
            };
            
            fetch('/api/convert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showConvertStatus('error', data.error);
                } else {
                    showConvertStatus('info', data.message);
                    document.getElementById('convert-progress').style.display = 'block';
                    pollStatus();
                }
            })
            .catch(error => {
                showConvertStatus('error', 'è¯·æ±‚å¤±è´¥: ' + error);
            });
        }
        
        function pollStatus() {
            fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                if (data.running) {
                    document.getElementById('progress-bar').style.width = data.progress + '%';
                    document.getElementById('convert-progress-bar').style.width = data.progress + '%';
                    setTimeout(pollStatus, 1000);
                } else {
                    document.getElementById('progress').style.display = 'none';
                    document.getElementById('convert-progress').style.display = 'none';
                    if (data.message) {
                        showStatus('success', data.message);
                        showConvertStatus('success', data.message);
                    }
                }
            });
        }
        
        function showStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function showConvertStatus(type, message) {
            const statusDiv = document.getElementById('convert-status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function loadDatasetInfo() {
            fetch('/api/dataset_info')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('dataset-info');
                container.innerHTML = `
                    <div class="info-card">
                        <h3>è®­ç»ƒå›¾ç‰‡</h3>
                        <p>${data.train_images}</p>
                    </div>
                    <div class="info-card">
                        <h3>éªŒè¯å›¾ç‰‡</h3>
                        <p>${data.val_images}</p>
                    </div>
                    <div class="info-card">
                        <h3>è®­ç»ƒæ ‡ç­¾</h3>
                        <p>${data.train_labels}</p>
                    </div>
                    <div class="info-card">
                        <h3>éªŒè¯æ ‡ç­¾</h3>
                        <p>${data.val_labels}</p>
                    </div>
                    <div class="info-card">
                        <h3>æ€»å›¾ç‰‡æ•°</h3>
                        <p>${data.total_images}</p>
                    </div>
                    <div class="info-card">
                        <h3>æ€»æ ‡ç­¾æ•°</h3>
                        <p>${data.total_labels}</p>
                    </div>
                `;
            });
        }
        
        function loadLogs() {
            fetch('/api/logs')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('log-container');
                container.innerHTML = data.logs.map(log => `<div>${log}</div>`).join('');
                container.scrollTop = container.scrollHeight;
            });
        }
        
        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
        }
        
        function validateJson() {
            const jsonPath = document.getElementById('json_path').value;
            if (!jsonPath) {
                showValidationResult('error', 'è¯·è¾“å…¥JSONæ–‡ä»¶è·¯å¾„');
                return;
            }
            
            fetch('/api/validate_json', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({json_path: jsonPath})
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showValidationResult('error', data.error);
                } else {
                    const status = data.valid ? 'success' : 'error';
                    const message = data.valid ? 
                        `JSONæ–‡ä»¶éªŒè¯é€šè¿‡ï¼å›¾ç‰‡: ${data.images_count}, æ ‡æ³¨: ${data.annotations_count}, ç±»åˆ«: ${data.categories_count}` :
                        `JSONæ–‡ä»¶éªŒè¯å¤±è´¥: ${data.issues.join(', ')}`;
                    showValidationResult(status, message);
                }
            })
            .catch(error => {
                showValidationResult('error', 'éªŒè¯å¤±è´¥: ' + error);
            });
        }
        
        function visualizeJson() {
            const jsonPath = document.getElementById('json_path').value;
            const imageIndex = parseInt(document.getElementById('image_index').value);
            
            if (!jsonPath) {
                showValidationResult('error', 'è¯·è¾“å…¥JSONæ–‡ä»¶è·¯å¾„');
                return;
            }
            
            fetch('/api/visualize_json', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    json_path: jsonPath,
                    image_index: imageIndex
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showValidationResult('error', data.error);
                } else {
                    displayKeypoints(data);
                    document.getElementById('visualization-section').style.display = 'block';
                }
            })
            .catch(error => {
                showValidationResult('error', 'å¯è§†åŒ–å¤±è´¥: ' + error);
            });
        }
        
        function showValidationResult(type, message) {
            const resultDiv = document.getElementById('validation-result');
            resultDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function displayKeypoints(data) {
            const container = document.getElementById('keypoints-display');
            const imageInfo = data.image_info;
            const keypoints = data.keypoints;
            
            let html = `
                <div class="info-card">
                    <h3>å›¾ç‰‡ä¿¡æ¯</h3>
                    <p>æ–‡ä»¶å: ${imageInfo.file_name}</p>
                    <p>å°ºå¯¸: ${imageInfo.width} x ${imageInfo.height}</p>
                    <p>æ ‡æ³¨æ•°é‡: ${data.annotations_count}</p>
                </div>
                <div class="info-card">
                    <h3>å…³é”®ç‚¹ä¿¡æ¯</h3>
                    <p>å…³é”®ç‚¹æ•°é‡: ${keypoints.length}</p>
                </div>
            `;
            
            if (keypoints.length > 0) {
                html += '<h4>å…³é”®ç‚¹è¯¦æƒ…:</h4><div style="max-height: 300px; overflow-y: auto;">';
                keypoints.forEach((kp, index) => {
                    const visibility = kp.visibility === 2 ? 'å¯è§' : kp.visibility === 1 ? 'é®æŒ¡' : 'ä¸å¯è§';
                    html += `
                        <div style="padding: 5px; border-bottom: 1px solid #eee;">
                            å…³é”®ç‚¹ ${kp.point_id}: (${kp.x.toFixed(2)}, ${kp.y.toFixed(2)}) - ${visibility}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function checkCocoStatus() {
            fetch('/api/coco_annotator_status')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('coco-status');
                const openBtn = document.getElementById('open-coco-btn');
                
                if (data.running) {
                    statusElement.innerHTML = 'âœ… COCO Annotatoræ­£åœ¨è¿è¡Œ';
                    statusElement.style.color = 'green';
                    openBtn.style.display = 'inline-block';
                } else {
                    statusElement.innerHTML = 'âŒ COCO Annotatoræœªè¿è¡Œ';
                    statusElement.style.color = 'red';
                    openBtn.style.display = 'none';
                }
                
                if (data.error) {
                    statusElement.innerHTML += `<br>é”™è¯¯: ${data.error}`;
                }
            })
            .catch(error => {
                document.getElementById('coco-status').innerHTML = 'âŒ æ£€æŸ¥çŠ¶æ€å¤±è´¥: ' + error;
            });
        }
        
        function startCocoAnnotator() {
            fetch('/api/start_coco_annotator', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showCocoMessage('error', data.error);
                } else {
                    showCocoMessage('info', data.message);
                    // ç­‰å¾…å‡ ç§’åæ£€æŸ¥çŠ¶æ€
                    setTimeout(() => {
                        checkCocoStatus();
                    }, 5000);
                }
            })
            .catch(error => {
                showCocoMessage('error', 'å¯åŠ¨å¤±è´¥: ' + error);
            });
        }
        
        function stopCocoAnnotator() {
            fetch('/api/stop_coco_annotator', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showCocoMessage('error', data.error);
                } else {
                    showCocoMessage('success', data.message);
                    checkCocoStatus();
                }
            })
            .catch(error => {
                showCocoMessage('error', 'åœæ­¢å¤±è´¥: ' + error);
            });
        }
        
        function openCocoAnnotator() {
            window.open('http://localhost:5000', '_blank');
        }
        
        function showCocoMessage(type, message) {
            const messageDiv = document.getElementById('coco-message');
            messageDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // ========== 3D ç«æŸ´äººæ¸²æŸ“ ==========
        // è¯´æ˜ï¼šWebç‰ˆæœ¬å¹¶æ²¡æœ‰ç›´æ¥è°ƒç”¨test_pose3d.pyçš„å‡½æ•°ï¼Œè€Œæ˜¯é‡æ–°å®ç°äº†ç±»ä¼¼çš„åŠŸèƒ½
        // å¯¹åº”å…³ç³»ï¼š
        // - select_best_keypoints() -> webç‰ˆæœ¬ä¸­çš„select_best_keypoints()ï¼ˆåç«¯ï¼‰
        // - map_2d_to_3d_centered() -> å‰ç«¯updateSkeletonFromKeypoints()ä¸­ä½¿ç”¨centerå’Œscaleå‚æ•°å®ç°
        // - ROIé€‰æ‹©é€»è¾‘ -> é€šè¿‡Canvasåœ¨å‰ç«¯å®ç°ï¼Œç±»ä¼¼test_pose3d.pyä¸­çš„cv2.selectROI()
        
        let threeRenderer, threeScene, threeCamera, threeControls;
        let skeletonLine;
        let poseEventSource = null;
        let roiSelecting = false;
        let roiStartX = 0, roiStartY = 0, roiCurrentX = 0, roiCurrentY = 0;
        let roiCanvas = null, roiCtx = null, roiImage = null;
        const COCO_EDGES = [
            [0, 1], [0, 2], [1, 3], [2, 4], [0, 5], [0, 6],
            [5, 7], [7, 9],
            [6, 8], [8, 10],
            [11, 13], [13, 15],
            [12, 14], [14, 16],
            [5, 6],
            [11, 12],
            [5, 11], [6, 12]
        ];

        function ensureThree() {
            if (threeRenderer) return;
            const container = document.getElementById('three-container');
            const w = container.clientWidth;
            const h = container.clientHeight;

            threeRenderer = new THREE.WebGLRenderer({ antialias: true });
            threeRenderer.setSize(w, h);
            threeRenderer.setPixelRatio(window.devicePixelRatio);
            container.innerHTML = '';
            container.appendChild(threeRenderer.domElement);

            threeScene = new THREE.Scene();
            threeScene.background = new THREE.Color(0x111111);

            threeCamera = new THREE.PerspectiveCamera(45, w / h, 0.01, 100);
            threeCamera.position.set(0, 0, 2.2);

            threeControls = new THREE.OrbitControls(threeCamera, threeRenderer.domElement);
            threeControls.enableDamping = true;

            const light = new THREE.DirectionalLight(0xffffff, 0.8);
            light.position.set(1, 1, 2);
            threeScene.add(light);
            threeScene.add(new THREE.AmbientLight(0xffffff, 0.3));

            const material = new THREE.LineBasicMaterial({ color: 0x44ccff, linewidth: 2 });
            const geometry = new THREE.BufferGeometry();
            const maxSegments = COCO_EDGES.length;
            const positions = new Float32Array(maxSegments * 2 * 3);
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            skeletonLine = new THREE.LineSegments(geometry, material);
            threeScene.add(skeletonLine);

            const coord = new THREE.AxesHelper(0.3);
            threeScene.add(coord);

            window.addEventListener('resize', () => {
                const w2 = container.clientWidth;
                const h2 = container.clientHeight;
                threeCamera.aspect = w2 / h2;
                threeCamera.updateProjectionMatrix();
                threeRenderer.setSize(w2, h2);
            });

            function animate() {
                requestAnimationFrame(animate);
                threeControls.update();
                threeRenderer.render(threeScene, threeCamera);
            }
            animate();
        }

        function updateSkeletonFromKeypoints(people, center, scale) {
            if (!skeletonLine) return;
            const pos = skeletonLine.geometry.attributes.position.array;
            const kp = (people && people.length > 0) ? people[0] : null;
            let idx = 0;
            
            if (kp && kp.length >= 17) {
                const s = scale || 1.0;
                const cx = center && center.length >= 2 ? center[0] : 0.5;
                const cy = center && center.length >= 2 ? center[1] : 0.5;
                
                function mapPt(p) {
                    const x = (p.x - cx) * s;
                    const y = -(p.y - cy) * s;
                    const z = 0.0;
                    return [x, y, z];
                }
                
                COCO_EDGES.forEach(edge => {
                    if (edge[0] < kp.length && edge[1] < kp.length) {
                        const a = mapPt(kp[edge[0]]);
                        const b = mapPt(kp[edge[1]]);
                        pos[idx++] = a[0]; pos[idx++] = a[1]; pos[idx++] = a[2];
                        pos[idx++] = b[0]; pos[idx++] = b[1]; pos[idx++] = b[2];
                    }
                });
            } else {
                for (let i = 0; i < pos.length; i++) pos[i] = 0;
            }
            skeletonLine.geometry.attributes.position.needsUpdate = true;
        }

        function startPoseStream() {
            ensureThree();
            const videoPath = document.getElementById('video_path').value;
            const modelPath = document.getElementById('pose_model_path').value;
            const conf = parseFloat(document.getElementById('pose_conf').value || '0.5');
            const roi = document.getElementById('pose_roi').value.trim() || null;
            
            if (!videoPath) {
                setPoseStatus('error', 'è¯·å¡«å†™è§†é¢‘è·¯å¾„');
                return;
            }
            
            const speed = parseFloat(document.getElementById('pose_speed').value || '1.0');
            const data = {
                video_path: videoPath,
                model_path: modelPath,
                conf_threshold: conf,
                playback_speed: speed
            };
            if (roi) {
                data.roi = roi;
            }
            
            fetch('/api/start_video_pose', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(r => r.json()).then(res => {
                if (res.error) {
                    setPoseStatus('error', res.error);
                    return;
                }
                setPoseStatus('info', 'è§†é¢‘å…³é”®ç‚¹æµå·²å¯åŠ¨');
                
                if (poseEventSource) {
                    poseEventSource.close();
                }
                
                poseEventSource = new EventSource('/api/pose_stream');
                poseEventSource.onmessage = (ev) => {
                    try {
                        const data = JSON.parse(ev.data);
                        if (data.type === 'keypoints') {
                            const scale = parseFloat(document.getElementById('pose_scale').value || '1.0');
                            updateSkeletonFromKeypoints(data.people, data.center, scale);
                            
                            // æ˜¾ç¤ºè§†é¢‘å¸§ï¼ˆä½¿ç”¨Imageå¯¹è±¡é¢„åŠ è½½ä»¥æå‡æµç•…åº¦ï¼‰
                            if (data.frame) {
                                const imgEl = document.getElementById('video_frame');
                                const placeholder = document.getElementById('video_placeholder');
                                
                                // ä½¿ç”¨Imageå¯¹è±¡é¢„åŠ è½½ï¼Œé¿å…é˜»å¡
                                const img = new Image();
                                img.onload = function() {
                                    imgEl.src = this.src;
                                };
                                img.src = 'data:image/jpeg;base64,' + data.frame;
                                
                                imgEl.style.display = 'block';
                                if (placeholder) placeholder.style.display = 'none';
                            }
                        } else if (data.type === 'error') {
                            setPoseStatus('error', data.message);
                        }
                    } catch (e) {
                        console.error('è§£æå…³é”®ç‚¹æ•°æ®å¤±è´¥:', e);
                    }
                };
                
                poseEventSource.addEventListener('end', () => {
                    setPoseStatus('success', 'è§†é¢‘å·²ç»“æŸ');
                    if (poseEventSource) {
                        poseEventSource.close();
                        poseEventSource = null;
                    }
                });
                
                poseEventSource.onerror = () => {
                    setPoseStatus('error', 'SSEè¿æ¥é”™è¯¯');
                };
            }).catch(err => setPoseStatus('error', 'å¯åŠ¨å¤±è´¥: ' + err));
        }

        function stopPoseStream() {
            if (poseEventSource) {
                poseEventSource.close();
                poseEventSource = null;
            }
            fetch('/api/stop_video_pose', { method: 'POST', headers: { 'Content-Type': 'application/json' }})
                .then(r => r.json())
                .then(res => setPoseStatus('info', res.message || 'å·²åœæ­¢'))
                .catch(() => setPoseStatus('error', 'åœæ­¢å¤±è´¥'));
        }

        function setPoseStatus(type, msg) {
            const el = document.getElementById('pose_status');
            el.innerHTML = `<div class="status ${type}">${msg}</div>`;
        }

        // ROIé€‰æ‹©åŠŸèƒ½
        function loadVideoFrame() {
            const videoPath = document.getElementById('video_path').value;
            if (!videoPath) {
                setPoseStatus('error', 'è¯·å…ˆå¡«å†™è§†é¢‘è·¯å¾„');
                return;
            }
            
            fetch('/api/get_video_first_frame', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ video_path: videoPath })
            }).then(r => r.json()).then(res => {
                if (res.error) {
                    setPoseStatus('error', res.error);
                    return;
                }
                
                roiCanvas = document.getElementById('roi_canvas');
                roiCtx = roiCanvas.getContext('2d');
                
                const img = new Image();
                img.onload = function() {
                    const maxWidth = 800;
                    const scale = Math.min(1, maxWidth / img.width);
                    roiCanvas.width = img.width * scale;
                    roiCanvas.height = img.height * scale;
                    
                    roiCtx.drawImage(img, 0, 0, roiCanvas.width, roiCanvas.height);
                    roiImage = { img: img, scale: scale, origWidth: img.width, origHeight: img.height };
                    
                    document.getElementById('roi_canvas_container').style.display = 'block';
                    setPoseStatus('info', 'è¯·åœ¨ç¬¬ä¸€å¸§ä¸Šæ‹–æ‹½é€‰æ‹©ROIåŒºåŸŸ');
                };
                img.src = res.frame;
            }).catch(err => setPoseStatus('error', 'åŠ è½½å¤±è´¥: ' + err));
        }

        // Canvas ROIé€‰æ‹©äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('roi_canvas');
            if (!canvas) return;
            
            canvas.addEventListener('mousedown', function(e) {
                if (!roiImage) return;
                roiSelecting = true;
                const rect = canvas.getBoundingClientRect();
                roiStartX = e.clientX - rect.left;
                roiStartY = e.clientY - rect.top;
            });
            
            canvas.addEventListener('mousemove', function(e) {
                if (!roiSelecting || !roiImage) return;
                const rect = canvas.getBoundingClientRect();
                roiCurrentX = e.clientX - rect.left;
                roiCurrentY = e.clientY - rect.top;
                
                roiCtx.clearRect(0, 0, canvas.width, canvas.height);
                roiCtx.drawImage(roiImage.img, 0, 0, canvas.width, canvas.height);
                
                const w = roiCurrentX - roiStartX;
                const h = roiCurrentY - roiStartY;
                roiCtx.strokeStyle = 'red';
                roiCtx.lineWidth = 2;
                roiCtx.strokeRect(roiStartX, roiStartY, w, h);
            });
            
            canvas.addEventListener('mouseup', function(e) {
                if (!roiSelecting || !roiImage) return;
                roiSelecting = false;
            });
        });

        function confirmROI() {
            if (!roiImage) return;
            
            const x = Math.min(roiStartX, roiCurrentX);
            const y = Math.min(roiStartY, roiCurrentY);
            const w = Math.abs(roiCurrentX - roiStartX);
            const h = Math.abs(roiCurrentY - roiStartY);
            
            if (w < 10 || h < 10) {
                setPoseStatus('error', 'ROIåŒºåŸŸå¤ªå°ï¼Œè¯·é‡æ–°é€‰æ‹©');
                return;
            }
            
            // è½¬æ¢ä¸ºåŸå§‹å›¾ç‰‡åæ ‡
            const origX = Math.floor(x / roiImage.scale);
            const origY = Math.floor(y / roiImage.scale);
            const origW = Math.floor(w / roiImage.scale);
            const origH = Math.floor(h / roiImage.scale);
            
            document.getElementById('pose_roi').value = `${origX},${origY},${origW},${origH}`;
            document.getElementById('roi_canvas_container').style.display = 'none';
            setPoseStatus('success', `ROIå·²è®¾ç½®: ${origX},${origY},${origW},${origH}`);
        }

        function cancelROISelection() {
            document.getElementById('roi_canvas_container').style.display = 'none';
            roiImage = null;
        }
        
        // ========== è§†é¢‘åŠ¨ä½œæ ‡æ³¨åŠŸèƒ½ ==========
        let videoActionData = null;
        let videoActionCurrentFrame = 0;
        let videoActionPlaying = false;
        let videoActionPlayInterval = null;
        let videoActionAnnotations = {};
        let videoActionCanvas = null;
        let videoActionCtx = null;
        let videoActionVideo = null;
        
        function startVideoActionLabeling() {
            const videoPath = document.getElementById('video_action_path').value;
            const modelPath = document.getElementById('video_action_model').value;
            const outputPath = document.getElementById('video_action_output').value || null;
            const conf = parseFloat(document.getElementById('video_action_conf').value || '0.5');
            const seqLen = parseInt(document.getElementById('video_action_seq_len').value || '30');
            const roi = document.getElementById('video_action_roi').value.trim() || null;
            
            if (!videoPath) {
                setVideoActionStatus('error', 'è¯·å¡«å†™è§†é¢‘è·¯å¾„');
                return;
            }
            
            setVideoActionStatus('info', 'æ­£åœ¨æå–å…³é”®ç‚¹ï¼Œè¯·ç¨å€™...');
            
            fetch('/api/start_video_action_labeling', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    video_path: videoPath,
                    model_path: modelPath,
                    output_path: outputPath,
                    conf_threshold: conf,
                    seq_len: seqLen,
                    roi: roi
                })
            }).then(r => r.json()).then(res => {
                if (res.error) {
                    setVideoActionStatus('error', res.error);
                    return;
                }
                setVideoActionStatus('success', 'å…³é”®ç‚¹æå–å®Œæˆï¼æ­£åœ¨åŠ è½½è§†é¢‘...');
                
                // è½®è¯¢çŠ¶æ€
                const checkInterval = setInterval(() => {
                    fetch('/api/get_video_labeling_status')
                        .then(r => r.json())
                        .then(status => {
                            if (!status.running && status.output_path) {
                                clearInterval(checkInterval);
                                loadVideoActionData(status.output_path, videoPath);
                            }
                        });
                }, 1000);
            }).catch(err => setVideoActionStatus('error', 'å¯åŠ¨å¤±è´¥: ' + err));
        }
        
        function loadVideoActionData(jsonPath, videoPath) {
            fetch('/api/get_file?path=' + encodeURIComponent(jsonPath))
                .then(r => r.json())
                .then(data => {
                    videoActionData = data;
                    videoActionAnnotations = {};
                    // è½¬æ¢æ ‡æ³¨æ ¼å¼
                    if (data.annotations) {
                        for (let start in data.annotations) {
                            const startFrame = parseInt(start);
                            const ends = data.annotations[start];
                            for (let end in ends) {
                                const endFrame = parseInt(end);
                                if (!videoActionAnnotations[startFrame]) {
                                    videoActionAnnotations[startFrame] = {};
                                }
                                videoActionAnnotations[startFrame][endFrame] = ends[end];
                            }
                        }
                    }
                    
                    // åŠ è½½è§†é¢‘
                    videoActionVideo = document.createElement('video');
                    videoActionVideo.src = videoPath.startsWith('./') || videoPath.startsWith('/') ? 
                        '/api/get_file?path=' + encodeURIComponent(videoPath) : videoPath;
                    videoActionVideo.crossOrigin = 'anonymous';
                    videoActionVideo.preload = 'metadata';
                    
                    videoActionVideo.addEventListener('loadedmetadata', () => {
                        document.getElementById('video_action_total_frames').textContent = data.total_frames;
                        videoActionCanvas = document.getElementById('video_action_canvas');
                        videoActionCtx = videoActionCanvas.getContext('2d');
                        videoActionCanvas.width = videoActionVideo.videoWidth;
                        videoActionCanvas.height = videoActionVideo.videoHeight;
                        
                        document.getElementById('video_action_player').style.display = 'block';
                        document.getElementById('save_video_annotation_btn').style.display = 'inline-block';
                        videoActionCurrentFrame = 0;
                        updateVideoActionFrame();
                        
                        // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
                        setupVideoActionKeyboard();
                        
                        // è‡ªåŠ¨å¼€å§‹æ’­æ”¾
                        setTimeout(() => {
                            videoActionPlaying = true;
                            videoActionPlayPause();
                        }, 500);
                    });
                    
                    videoActionVideo.addEventListener('error', () => {
                        setVideoActionStatus('error', 'æ— æ³•åŠ è½½è§†é¢‘æ–‡ä»¶ã€‚è¯·ç¡®ä¿è§†é¢‘è·¯å¾„æ­£ç¡®ã€‚');
                    });
                })
                .catch(err => setVideoActionStatus('error', 'åŠ è½½æ•°æ®å¤±è´¥: ' + err));
        }
        
        function updateVideoActionFrame() {
            if (!videoActionVideo || !videoActionCanvas) return;
            
            videoActionVideo.currentTime = videoActionCurrentFrame / (videoActionData.fps || 30);
            videoActionVideo.addEventListener('seeked', () => {
                videoActionCtx.drawImage(videoActionVideo, 0, 0);
                
                // ç»˜åˆ¶å…³é”®ç‚¹
                if (videoActionCurrentFrame < videoActionData.keypoint_sequence.length) {
                    const kp = videoActionData.keypoint_sequence[videoActionCurrentFrame];
                    if (kp && kp.length >= 34) {
                        const h = videoActionCanvas.height;
                        const w = videoActionCanvas.width;
                        
                        // ç»˜åˆ¶å…³é”®ç‚¹
                        videoActionCtx.fillStyle = '#ffff00';
                        for (let i = 0; i < 17; i++) {
                            const x = kp[i * 2] * w;
                            const y = kp[i * 2 + 1] * h;
                            videoActionCtx.beginPath();
                            videoActionCtx.arc(x, y, 3, 0, Math.PI * 2);
                            videoActionCtx.fill();
                        }
                        
                        // ç»˜åˆ¶éª¨æ¶è¿çº¿
                        const edges = [[0,1],[0,2],[1,3],[2,4],[0,5],[0,6],[5,7],[7,9],[6,8],[8,10],
                                      [11,13],[13,15],[12,14],[14,16],[5,6],[11,12],[5,11],[6,12]];
                        videoActionCtx.strokeStyle = '#00c8ff';
                        videoActionCtx.lineWidth = 2;
                        edges.forEach(e => {
                            const [a, b] = e;
                            if (a < 17 && b < 17) {
                                videoActionCtx.beginPath();
                                videoActionCtx.moveTo(kp[a*2]*w, kp[a*2+1]*h);
                                videoActionCtx.lineTo(kp[b*2]*w, kp[b*2+1]*h);
                                videoActionCtx.stroke();
                            }
                        });
                    }
                }
                
                // æ›´æ–°å½“å‰åŠ¨ä½œæ˜¾ç¤º
                const currentAction = getVideoActionCurrentAction();
                document.getElementById('video_action_current_action').textContent = currentAction;
                document.getElementById('video_action_frame').textContent = videoActionCurrentFrame;
            }, { once: true });
        }
        
        function getVideoActionCurrentAction() {
            for (let start in videoActionAnnotations) {
                const startFrame = parseInt(start);
                if (videoActionCurrentFrame >= startFrame) {
                    const ends = videoActionAnnotations[start];
                    for (let end in ends) {
                        const endFrame = parseInt(end);
                        if (videoActionCurrentFrame <= endFrame) {
                            const actionId = ends[end];
                            const actionMap = {0: 'W-å‰è¿›', 1: 'A-å·¦', 2: 'S-åé€€', 3: 'D-å³', 4: 'ç©ºæ ¼-è·³è·ƒ', 5: 'I-é™æ­¢'};
                            return actionMap[actionId] || 'æœªçŸ¥';
                        }
                    }
                }
            }
            return 'æœªæ ‡æ³¨';
        }
        
        function videoActionPlayPause() {
            videoActionPlaying = !videoActionPlaying;
            if (videoActionPlaying) {
                if (videoActionPlayInterval) clearInterval(videoActionPlayInterval);
                // è‡ªåŠ¨æ’­æ”¾æ¨¡å¼ï¼šæŒç»­æ’­æ”¾ï¼Œé‡åˆ°æœªæ ‡æ³¨å¸§æ—¶æš‚åœ
                videoActionPlayInterval = setInterval(() => {
                    if (!videoActionPlaying) {
                        clearInterval(videoActionPlayInterval);
                        return;
                    }
                    
                    const labelFrames = parseInt(document.getElementById('video_action_label_frames').value || '1');
                    
                    // æ£€æŸ¥æ¥ä¸‹æ¥éœ€è¦æ ‡æ³¨çš„å¸§æ˜¯å¦å·²æ ‡æ³¨
                    let needLabel = false;
                    let nextUnlabeledFrame = videoActionCurrentFrame + 1;
                    
                    for (let i = 0; i < labelFrames && (videoActionCurrentFrame + 1 + i) < videoActionData.total_frames; i++) {
                        const checkFrame = videoActionCurrentFrame + 1 + i;
                        if (!isFrameLabeled(checkFrame)) {
                            needLabel = true;
                            nextUnlabeledFrame = checkFrame;
                            break;
                        }
                    }
                    
                    if (nextUnlabeledFrame >= videoActionData.total_frames) {
                        // åˆ°è¾¾æœ«å°¾ï¼Œåœæ­¢æ’­æ”¾
                        videoActionPlaying = false;
                        clearInterval(videoActionPlayInterval);
                        setVideoActionStatus('success', 'è§†é¢‘æ’­æ”¾å®Œæˆï¼');
                        return;
                    }
                    
                    if (needLabel) {
                        // å¦‚æœæœ‰æœªæ ‡æ³¨çš„å¸§ï¼Œæš‚åœæ’­æ”¾ç­‰å¾…æ ‡æ³¨
                        videoActionPlaying = false;
                        clearInterval(videoActionPlayInterval);
                        videoActionCurrentFrame = nextUnlabeledFrame;
                        updateVideoActionFrame();
                        setVideoActionStatus('info', `å¸§ ${nextUnlabeledFrame} æœªæ ‡æ³¨ï¼Œå·²æš‚åœã€‚è¯·æŒ‰W/A/S/D/ç©ºæ ¼/Iæ ‡æ³¨ã€‚`);
                        return;
                    }
                    
                    // å¦‚æœæ¥ä¸‹æ¥çš„å¸§éƒ½å·²æ ‡æ³¨ï¼Œå‰è¿›labelFrameså¸§
                    videoActionCurrentFrame = Math.min(videoActionCurrentFrame + labelFrames, videoActionData.total_frames - 1);
                    updateVideoActionFrame();
                }, 1000 / (videoActionData.fps || 30));
            } else {
                // æš‚åœ
                if (videoActionPlayInterval) {
                    clearInterval(videoActionPlayInterval);
                    videoActionPlayInterval = null;
                }
                setVideoActionStatus('info', 'å·²æš‚åœã€‚å¯ä»¥ä¿®æ”¹å½“å‰å¸§æ ‡ç­¾æˆ–æŒ‰æ’­æ”¾ç»§ç»­ã€‚');
            }
        }
        
        function isFrameLabeled(frame) {
            for (let start in videoActionAnnotations) {
                const startFrame = parseInt(start);
                if (frame >= startFrame) {
                    const ends = videoActionAnnotations[start];
                    for (let end in ends) {
                        const endFrame = parseInt(end);
                        if (frame <= endFrame) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }
        
        function setupVideoActionKeyboard() {
            // æ·»åŠ å…¨å±€é”®ç›˜äº‹ä»¶ç›‘å¬ï¼ˆä»…åœ¨è§†é¢‘æ’­æ”¾å™¨æ˜¾ç¤ºæ—¶æœ‰æ•ˆï¼‰
            // ä½¿ç”¨ä¸€æ¬¡æ€§äº‹ä»¶ç›‘å¬ï¼Œé¿å…é‡å¤ç»‘å®š
            if (window.videoActionKeyboardSetup) return;
            window.videoActionKeyboardSetup = true;
            
            document.addEventListener('keydown', function(e) {
                // æ£€æŸ¥æ˜¯å¦åœ¨è§†é¢‘æ ‡æ³¨æ ‡ç­¾é¡µ
                const videoPlayer = document.getElementById('video_action_player');
                if (!videoPlayer || videoPlayer.style.display === 'none') return;
                
                // æ£€æŸ¥ç„¦ç‚¹æ˜¯å¦åœ¨è¾“å…¥æ¡†ä¸­
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                const key = e.key.toLowerCase();
                
                // é”®ç›˜å¿«æ·é”®
                if (key === 'w') {
                    e.preventDefault();
                    videoActionLabel('w');
                } else if (key === 'a') {
                    e.preventDefault();
                    videoActionLabel('a');
                } else if (key === 's') {
                    e.preventDefault();
                    videoActionLabel('s');
                } else if (key === 'd') {
                    e.preventDefault();
                    videoActionLabel('d');
                } else if (key === ' ') {
                    e.preventDefault();
                    // ç©ºæ ¼é”®ä¼˜å…ˆç”¨äºæ ‡æ³¨è·³è·ƒï¼Œè€Œä¸æ˜¯æ’­æ”¾/æš‚åœ
                    videoActionLabel(' ');
                } else if (key === 'i') {
                    e.preventDefault();
                    videoActionLabel('idle');
                } else if (key === 'p') {
                    // Pé”®ç”¨äºæ’­æ”¾/æš‚åœ
                    e.preventDefault();
                    videoActionPlayPause();
                } else if (key === 'arrowleft') {
                    e.preventDefault();
                    videoActionPrevFrame();
                    // å‰è¿›/åé€€æ—¶æš‚åœæ’­æ”¾
                    if (videoActionPlaying) {
                        videoActionPlaying = false;
                        if (videoActionPlayInterval) {
                            clearInterval(videoActionPlayInterval);
                            videoActionPlayInterval = null;
                        }
                    }
                } else if (key === 'arrowright') {
                    e.preventDefault();
                    videoActionNextFrame();
                    // å‰è¿›/åé€€æ—¶æš‚åœæ’­æ”¾
                    if (videoActionPlaying) {
                        videoActionPlaying = false;
                        if (videoActionPlayInterval) {
                            clearInterval(videoActionPlayInterval);
                            videoActionPlayInterval = null;
                        }
                    }
                }
            });
        }
        
        function videoActionPrevFrame() {
            videoActionCurrentFrame = Math.max(0, videoActionCurrentFrame - 10);
            updateVideoActionFrame();
        }
        
        function videoActionNextFrame() {
            videoActionCurrentFrame = Math.min(videoActionData.total_frames - 1, videoActionCurrentFrame + 10);
            updateVideoActionFrame();
        }
        
        function videoActionLabel(action) {
            if (!videoActionData) return;
            
            const actionMap = {'w': 0, 'a': 1, 's': 2, 'd': 3, ' ': 4, 'idle': 5};
            const actionId = actionMap[action];
            const seqLen = parseInt(document.getElementById('video_action_seq_len').value || '30');
            const labelFrames = parseInt(document.getElementById('video_action_label_frames').value || '1');
            
            // è®¡ç®—è¦æ ‡æ³¨çš„å¸§èŒƒå›´
            const startFrame = videoActionCurrentFrame;
            const endFrame = Math.min(videoActionCurrentFrame + seqLen - 1, videoActionData.total_frames - 1);
            
            // å¦‚æœè®¾ç½®äº†æ ‡æ³¨è¦†ç›–å¸§æ•° > 1ï¼Œåˆ™æ‰¹é‡æ ‡æ³¨å¤šå¸§
            if (labelFrames > 1) {
                // æ‰¹é‡æ ‡æ³¨ï¼šä»å½“å‰å¸§å¼€å§‹ï¼Œæ¯éš”labelFrameså¸§æ ‡æ³¨ä¸€æ¬¡
                let labeledCount = 0;
                for (let frame = startFrame; frame <= endFrame; frame += labelFrames) {
                    // æ¸…é™¤è¯¥å¸§çš„æ—§æ ‡æ³¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (videoActionAnnotations[frame]) {
                        delete videoActionAnnotations[frame];
                    }
                    
                    // æ·»åŠ æ–°æ ‡æ³¨
                    if (!videoActionAnnotations[frame]) {
                        videoActionAnnotations[frame] = {};
                    }
                    // æ¯å¸§çš„æ ‡æ³¨æŒç»­æ—¶é—´ä¹Ÿæ˜¯seqLen
                    const frameEndFrame = Math.min(frame + seqLen - 1, videoActionData.total_frames - 1);
                    videoActionAnnotations[frame][frameEndFrame] = actionId;
                    labeledCount++;
                }
                
                const actionNames = {'w': 'å‰è¿›', 'a': 'å·¦ç§»', 's': 'åé€€', 'd': 'å³ç§»', ' ': 'è·³è·ƒ', 'idle': 'é™æ­¢'};
                setVideoActionStatus('success', `å·²æ‰¹é‡æ ‡æ³¨: å¸§ ${startFrame}-${endFrame} (å…±${labeledCount}ä¸ªæ ‡æ³¨ç‚¹) ä¸º ${actionNames[action] || action.toUpperCase()}`);
            } else {
                // å•å¸§æ ‡æ³¨ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
                // å¦‚æœå½“å‰å¸§å·²æœ‰æ ‡æ³¨ï¼Œå…ˆæ¸…é™¤ï¼ˆå…è®¸ä¿®æ”¹ï¼‰
                if (videoActionAnnotations[videoActionCurrentFrame]) {
                    delete videoActionAnnotations[videoActionCurrentFrame];
                }
                
                // æ·»åŠ æ–°æ ‡æ³¨
                if (!videoActionAnnotations[videoActionCurrentFrame]) {
                    videoActionAnnotations[videoActionCurrentFrame] = {};
                }
                videoActionAnnotations[videoActionCurrentFrame][endFrame] = actionId;
                
                const actionNames = {'w': 'å‰è¿›', 'a': 'å·¦ç§»', 's': 'åé€€', 'd': 'å³ç§»', ' ': 'è·³è·ƒ', 'idle': 'é™æ­¢'};
                setVideoActionStatus('success', `å·²æ ‡æ³¨: å¸§ ${startFrame}-${endFrame} ä¸º ${actionNames[action] || action.toUpperCase()}`);
            }
            
            updateVideoActionFrame();
            
            // å¦‚æœå½“å‰æ˜¯æš‚åœçŠ¶æ€ï¼Œæ ‡æ³¨åè‡ªåŠ¨å‰è¿›
            if (!videoActionPlaying) {
                // æ ¹æ®æ ‡æ³¨è¦†ç›–å¸§æ•°å†³å®šå‰è¿›å¤šå°‘å¸§
                const advanceFrames = labelFrames > 1 ? labelFrames : 1;
                const nextFrame = videoActionCurrentFrame + advanceFrames;
                
                if (nextFrame < videoActionData.total_frames) {
                    videoActionCurrentFrame = nextFrame;
                    updateVideoActionFrame();
                    
                    // æ£€æŸ¥æ¥ä¸‹æ¥éœ€è¦æ ‡æ³¨çš„å¸§æ˜¯å¦å·²æ ‡æ³¨
                    let needLabel = false;
                    for (let i = 0; i < labelFrames && (nextFrame + i) < videoActionData.total_frames; i++) {
                        if (!isFrameLabeled(nextFrame + i)) {
                            needLabel = true;
                            break;
                        }
                    }
                    
                    if (needLabel) {
                        setVideoActionStatus('info', `å·²å‰è¿›åˆ°å¸§ ${nextFrame}ã€‚è¯·ç»§ç»­æ ‡æ³¨ï¼ˆW/A/S/D/ç©ºæ ¼/Iï¼‰ã€‚`);
                    } else {
                        // å¦‚æœæ¥ä¸‹æ¥çš„å¸§éƒ½å·²æ ‡æ³¨ï¼Œè‡ªåŠ¨ç»§ç»­æ’­æ”¾
                        setTimeout(() => {
                            if (!videoActionPlaying) {
                                videoActionPlaying = true;
                                videoActionPlayPause();
                            }
                        }, 300);
                    }
                } else {
                    setVideoActionStatus('success', 'è§†é¢‘æ ‡æ³¨å®Œæˆï¼');
                }
            }
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œæ ‡æ³¨åä¼šè‡ªåŠ¨ç»§ç»­æ’­æ”¾ï¼ˆç”±æ’­æ”¾å¾ªç¯å¤„ç†ï¼‰
        }
        
        function saveVideoAnnotation() {
            if (!videoActionData) {
                setVideoActionStatus('error', 'æ²¡æœ‰å¯ä¿å­˜çš„æ•°æ®');
                return;
            }
            
            let outputPath = document.getElementById('video_action_output').value;
            if (!outputPath && videoActionData.video_path) {
                outputPath = videoActionData.video_path.replace(/\.[^/.]+$/, '_action_labels.json');
            }
            
            if (!outputPath) {
                setVideoActionStatus('error', 'è¯·æŒ‡å®šè¾“å‡ºè·¯å¾„');
                return;
            }
            
            // è½¬æ¢æ ‡æ³¨æ ¼å¼å›åŸå§‹æ ¼å¼
            const annotations = {};
            for (let start in videoActionAnnotations) {
                const startFrame = parseInt(start);
                const ends = videoActionAnnotations[start];
                annotations[startFrame] = {};
                for (let end in ends) {
                    annotations[startFrame][parseInt(end)] = ends[end];
                }
            }
            
            fetch('/api/save_video_annotation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    output_path: outputPath,
                    annotations: annotations
                })
            }).then(r => r.json()).then(res => {
                if (res.error) {
                    setVideoActionStatus('error', res.error);
                } else {
                    setVideoActionStatus('success', 'æ ‡æ³¨å·²ä¿å­˜: ' + outputPath);
                }
            }).catch(err => setVideoActionStatus('error', 'ä¿å­˜å¤±è´¥: ' + err));
        }
        
        function setVideoActionStatus(type, msg) {
            const el = document.getElementById('video_action_status');
            el.className = type;
            el.textContent = msg;
        }
        
        // ========== å®æ—¶æ¸¸æˆæ ‡æ³¨åŠŸèƒ½ ==========
        let realtimeLabelingStatusInterval = null;
        
        function startRealtimeLabeling() {
            const modelPath = document.getElementById('realtime_action_model').value;
            const monitor = document.getElementById('realtime_action_monitor').value.trim() || null;
            const conf = parseFloat(document.getElementById('realtime_action_conf').value || '0.5');
            const fps = parseFloat(document.getElementById('realtime_action_fps').value || '30');
            const outputPath = document.getElementById('realtime_action_output').value.trim() || null;
            const seqLen = parseInt(document.getElementById('realtime_action_seq_len').value || '30');
            
            setRealtimeActionStatus('info', 'æ­£åœ¨å¯åŠ¨å®æ—¶æ ‡æ³¨...');
            
            fetch('/api/start_realtime_labeling', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model_path: modelPath,
                    monitor: monitor,
                    conf_threshold: conf,
                    fps: fps,
                    output_path: outputPath,
                    seq_len: seqLen
                })
            }).then(r => r.json()).then(res => {
                if (res.error) {
                    setRealtimeActionStatus('error', res.error);
                    return;
                }
                setRealtimeActionStatus('success', 'å®æ—¶æ ‡æ³¨å·²å¯åŠ¨ï¼è¯·åœ¨3ç§’å†…åˆ‡æ¢åˆ°æ¸¸æˆçª—å£');
                document.getElementById('stop_realtime_btn').style.display = 'inline-block';
                document.getElementById('realtime_action_preview').style.display = 'block';
                
                // è½®è¯¢çŠ¶æ€
                realtimeLabelingStatusInterval = setInterval(() => {
                    fetch('/api/get_realtime_labeling_status')
                        .then(r => r.json())
                        .then(status => {
                            if (status.running) {
                                document.getElementById('realtime_action_state').textContent = 'è¿è¡Œä¸­';
                            } else {
                                clearInterval(realtimeLabelingStatusInterval);
                                document.getElementById('realtime_action_state').textContent = 'å·²åœæ­¢';
                                if (status.output_path) {
                                    setRealtimeActionStatus('success', 'æ ‡æ³¨å·²ä¿å­˜: ' + status.output_path);
                                }
                            }
                        });
                }, 1000);
            }).catch(err => setRealtimeActionStatus('error', 'å¯åŠ¨å¤±è´¥: ' + err));
        }
        
        function stopRealtimeLabeling() {
            fetch('/api/stop_realtime_labeling', { method: 'POST' })
                .then(r => r.json())
                .then(res => {
                    setRealtimeActionStatus('info', res.message || 'åœæ­¢æŒ‡ä»¤å·²å‘é€');
                    if (realtimeLabelingStatusInterval) {
                        clearInterval(realtimeLabelingStatusInterval);
                        realtimeLabelingStatusInterval = null;
                    }
                })
                .catch(err => setRealtimeActionStatus('error', 'åœæ­¢å¤±è´¥: ' + err));
        }
        
        function setRealtimeActionStatus(type, msg) {
            const el = document.getElementById('realtime_action_status');
            el.className = type;
            el.textContent = msg;
        }
        
        // ========== åŠ¨ä½œåˆ†ç±»è®­ç»ƒåŠŸèƒ½ ==========
        let trainingStatusInterval = null;
        
        function startActionTraining() {
            const dataPath = document.getElementById('training_data_path').value;
            const modelType = document.getElementById('training_model_type').value;
            const seqLen = parseInt(document.getElementById('training_seq_len').value || '30');
            const hiddenDim = parseInt(document.getElementById('training_hidden_dim').value || '128');
            const numLayers = parseInt(document.getElementById('training_num_layers').value || '2');
            const batchSize = parseInt(document.getElementById('training_batch_size').value || '32');
            const epochs = parseInt(document.getElementById('training_epochs').value || '50');
            const lr = parseFloat(document.getElementById('training_lr').value || '0.001');
            const outputDir = document.getElementById('training_output').value || './models/action_classifier';
            
            if (!dataPath) {
                setTrainingStatus('error', 'è¯·å¡«å†™æ ‡æ³¨æ•°æ®è·¯å¾„');
                return;
            }
            
            setTrainingStatus('info', 'æ­£åœ¨å¯åŠ¨è®­ç»ƒ...');
            document.getElementById('training_progress').style.display = 'block';
            document.getElementById('stop_training_btn').style.display = 'inline-block';
            
            fetch('/api/start_action_training', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    data_path: dataPath,
                    model_type: modelType,
                    seq_len: seqLen,
                    hidden_dim: hiddenDim,
                    num_layers: numLayers,
                    batch_size: batchSize,
                    epochs: epochs,
                    learning_rate: lr,
                    output_dir: outputDir
                })
            }).then(r => r.json()).then(res => {
                if (res.error) {
                    setTrainingStatus('error', res.error);
                    return;
                }
                setTrainingStatus('success', 'è®­ç»ƒå·²å¯åŠ¨');
                
                // è½®è¯¢è®­ç»ƒçŠ¶æ€
                trainingStatusInterval = setInterval(() => {
                    fetch('/api/get_training_status')
                        .then(r => r.json())
                        .then(status => {
                            if (status.running) {
                                // æ›´æ–°è¿›åº¦
                                if (status.current_epoch && status.total_epochs) {
                                    const progress = (status.current_epoch / status.total_epochs) * 100;
                                    document.getElementById('training_progress_bar').style.width = progress + '%';
                                }
                                
                                // æ›´æ–°æ—¥å¿—
                                if (status.logs && status.logs.length > 0) {
                                    const logsDiv = document.getElementById('training_logs');
                                    logsDiv.innerHTML = status.logs.slice(-20).map(log => `<div>${log}</div>`).join('');
                                    logsDiv.scrollTop = logsDiv.scrollHeight;
                                }
                            } else {
                                clearInterval(trainingStatusInterval);
                                document.getElementById('stop_training_btn').style.display = 'none';
                                if (status.message) {
                                    setTrainingStatus('success', status.message);
                                }
                            }
                        });
                }, 2000);
            }).catch(err => setTrainingStatus('error', 'å¯åŠ¨å¤±è´¥: ' + err));
        }
        
        function stopActionTraining() {
            fetch('/api/stop_action_training', { method: 'POST' })
                .then(r => r.json())
                .then(res => {
                    setTrainingStatus('info', res.message || 'åœæ­¢æŒ‡ä»¤å·²å‘é€');
                    if (trainingStatusInterval) {
                        clearInterval(trainingStatusInterval);
                        trainingStatusInterval = null;
                    }
                })
                .catch(err => setTrainingStatus('error', 'åœæ­¢å¤±è´¥: ' + err));
        }
        
        function setTrainingStatus(type, msg) {
            const el = document.getElementById('training_status');
            el.className = type;
            el.textContent = msg;
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®é›†ä¿¡æ¯
        window.onload = function() {
            loadDatasetInfo();
            loadLogs();
            checkCocoStatus();
        };
    </script>
</body>
</html>
    