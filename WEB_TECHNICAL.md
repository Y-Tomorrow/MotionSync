# MotionSync Webåº”ç”¨æŠ€æœ¯åŸç†è¯¦è§£

æœ¬æ–‡æ¡£è¯¦ç»†è§£é‡ŠMotionSync Webåº”ç”¨çš„è¿è¡ŒåŸç†å’ŒæŠ€æœ¯å®ç°ã€‚

---

## ğŸ“‹ ç›®å½•

1. [æ•´ä½“æ¶æ„](#1-æ•´ä½“æ¶æ„)
2. [Flaskæ¡†æ¶åŸºç¡€](#2-flaskæ¡†æ¶åŸºç¡€)
3. [å¯åŠ¨æµç¨‹è¯¦è§£](#3-å¯åŠ¨æµç¨‹è¯¦è§£)
4. [è·¯ç”±ç³»ç»Ÿ](#4-è·¯ç”±ç³»ç»Ÿ)
5. [æ¨¡æ¿æ¸²æŸ“æœºåˆ¶](#5-æ¨¡æ¿æ¸²æŸ“æœºåˆ¶)
6. [å‰åç«¯äº¤äº’](#6-å‰åç«¯äº¤äº’)
7. [å®æ—¶é€šä¿¡æŠ€æœ¯](#7-å®æ—¶é€šä¿¡æŠ€æœ¯)
8. [è¯·æ±‚å¤„ç†æµç¨‹](#8-è¯·æ±‚å¤„ç†æµç¨‹)
9. [ç½‘ç»œè®¿é—®åŸç†](#9-ç½‘ç»œè®¿é—®åŸç†)

---

## 1. æ•´ä½“æ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æµè§ˆå™¨ (å®¢æˆ·ç«¯)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  HTML/CSS/JavaScript å‰ç«¯ç•Œé¢                    â”‚  â”‚
â”‚  â”‚  - æ ‡ç­¾é¡µåˆ‡æ¢                                     â”‚  â”‚
â”‚  â”‚  - è¡¨å•æäº¤                                       â”‚  â”‚
â”‚  â”‚  - AJAXè¯·æ±‚                                       â”‚  â”‚
â”‚  â”‚  - EventSource (SSE)                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ HTTP/HTTPS åè®®
                    â”‚ (GET/POSTè¯·æ±‚)
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Flask WebæœåŠ¡å™¨ (åç«¯)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Flaskåº”ç”¨å®ä¾‹ (app)                              â”‚  â”‚
â”‚  â”‚  - è·¯ç”±æ³¨å†Œ (@app.route)                         â”‚  â”‚
â”‚  â”‚  - è¯·æ±‚å¤„ç†å‡½æ•°                                   â”‚  â”‚
â”‚  â”‚  - æ¨¡æ¿æ¸²æŸ“ (render_template)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä¸šåŠ¡é€»è¾‘å±‚                                       â”‚  â”‚
â”‚  â”‚  - ä½å§¿æå– (auto_label.py)                      â”‚  â”‚
â”‚  â”‚  - æ ¼å¼è½¬æ¢ (txt_coco_json.py)                   â”‚  â”‚
â”‚  â”‚  - æ¨¡å‹è®­ç»ƒ (train_action_classifier.py)         â”‚  â”‚
â”‚  â”‚  - è§†é¢‘å¤„ç† (video_action_labeler.py)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  çŠ¶æ€ç®¡ç†                                        â”‚  â”‚
â”‚  â”‚  - task_status (ä»»åŠ¡çŠ¶æ€)                        â”‚  â”‚
â”‚  â”‚  - pose_stream_state (è§†é¢‘æµçŠ¶æ€)                â”‚  â”‚
â”‚  â”‚  - action_labeling_state (æ ‡æ³¨çŠ¶æ€)             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**: Flask (Python)
- **å‰ç«¯æŠ€æœ¯**: HTML5 + CSS3 + JavaScript (åŸç”Ÿ)
- **å®æ—¶é€šä¿¡**: Server-Sent Events (SSE)
- **æ•°æ®æ ¼å¼**: JSON
- **æ·±åº¦å­¦ä¹ **: PyTorch, Ultralytics YOLO

---

## 2. Flaskæ¡†æ¶åŸºç¡€

### ä»€ä¹ˆæ˜¯Flaskï¼Ÿ

Flaskæ˜¯ä¸€ä¸ªè½»é‡çº§çš„Python Webæ¡†æ¶ï¼Œé‡‡ç”¨**WSGI (Web Server Gateway Interface)**æ ‡å‡†ï¼Œç”¨äºæ„å»ºWebåº”ç”¨ã€‚

### Flaskæ ¸å¿ƒæ¦‚å¿µ

#### 1. åº”ç”¨å®ä¾‹

```python
from flask import Flask

app = Flask(__name__)
```

- `Flask(__name__)` åˆ›å»ºFlaskåº”ç”¨å®ä¾‹
- `__name__` ç”¨äºå®šä½èµ„æºæ–‡ä»¶ï¼ˆæ¨¡æ¿ã€é™æ€æ–‡ä»¶ç­‰ï¼‰
- `app` æ˜¯åº”ç”¨çš„æ ¸å¿ƒå¯¹è±¡ï¼Œæ‰€æœ‰è·¯ç”±å’Œé…ç½®éƒ½ç»‘å®šåˆ°å®ƒ

#### 2. è·¯ç”±è£…é¥°å™¨

```python
@app.route('/')
def index():
    return render_template('index.html')
```

- `@app.route('/')` å®šä¹‰URLè·¯å¾„ä¸å¤„ç†å‡½æ•°çš„æ˜ å°„å…³ç³»
- å½“ç”¨æˆ·è®¿é—® `http://localhost:8080/` æ—¶ï¼ŒFlaskä¼šè°ƒç”¨ `index()` å‡½æ•°
- è¿”å›çš„å†…å®¹ä¼šä½œä¸ºHTTPå“åº”å‘é€ç»™æµè§ˆå™¨

#### 3. è¯·æ±‚å¯¹è±¡

```python
from flask import request

@app.route('/api/auto_label', methods=['POST'])
def auto_label():
    data = request.json  # è·å–JSONè¯·æ±‚ä½“
    img_dir = data.get('img_dir')
```

- `request` å¯¹è±¡åŒ…å«å®¢æˆ·ç«¯å‘é€çš„æ‰€æœ‰ä¿¡æ¯
- `request.json` è·å–JSONæ ¼å¼çš„è¯·æ±‚ä½“
- `request.args` è·å–URLæŸ¥è¯¢å‚æ•°
- `request.method` è·å–HTTPæ–¹æ³•ï¼ˆGET/POSTç­‰ï¼‰

#### 4. å“åº”å¯¹è±¡

```python
from flask import jsonify

return jsonify({'message': 'æˆåŠŸ', 'data': result})
```

- `jsonify()` å°†Pythonå­—å…¸è½¬æ¢ä¸ºJSONå“åº”
- Flaskè‡ªåŠ¨è®¾ç½®æ­£ç¡®çš„Content-Typeå¤´

---

## 3. å¯åŠ¨æµç¨‹è¯¦è§£

### è¿è¡Œ `python web_app.py` æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

#### æ­¥éª¤1: å¯¼å…¥æ¨¡å—å’Œåˆå§‹åŒ–

```python
# 1. å¯¼å…¥Flaskæ¡†æ¶
from flask import Flask, render_template, request, jsonify, ...

# 2. åˆ›å»ºFlaskåº”ç”¨å®ä¾‹
app = Flask(__name__)

# 3. å¯¼å…¥ä¸šåŠ¡æ¨¡å—
from auto_label import auto_label_yolo_format
from txt_coco_json import txt_to_coco, coco_to_txt
```

**è¯´æ˜**:
- Pythonè§£é‡Šå™¨æ‰§è¡Œæ‰€æœ‰importè¯­å¥
- åˆ›å»ºFlaskåº”ç”¨å¯¹è±¡
- å¯¼å…¥æ‰€æœ‰éœ€è¦çš„åŠŸèƒ½æ¨¡å—

#### æ­¥éª¤2: å®šä¹‰è·¯ç”±

```python
@app.route('/')
def index():
    return render_template('index.html')

@app.route('/api/auto_label', methods=['POST'])
def auto_label():
    # ...
```

**è¯´æ˜**:
- Flaskæ‰«ææ‰€æœ‰ä½¿ç”¨ `@app.route` è£…é¥°çš„å‡½æ•°
- å°†è¿™äº›å‡½æ•°æ³¨å†Œåˆ°è·¯ç”±è¡¨ä¸­
- å»ºç«‹URLè·¯å¾„ä¸å¤„ç†å‡½æ•°çš„æ˜ å°„å…³ç³»

#### æ­¥éª¤3: åˆå§‹åŒ–æ£€æŸ¥

```python
if __name__ == '__main__':
    setup_logging()  # è®¾ç½®æ—¥å¿—ç³»ç»Ÿ
    
    # åˆ›å»ºtemplatesç›®å½•
    templates_dir = Path('templates')
    templates_dir.mkdir(exist_ok=True)
    
    # æ£€æŸ¥å¹¶ç”ŸæˆHTMLæ–‡ä»¶
    html_file = templates_dir / 'index.html'
    if not html_file.exists():
        # ç”ŸæˆHTMLå†…å®¹ï¼ˆä»£ç ä¸­å†…åµŒçš„HTMLå­—ç¬¦ä¸²ï¼‰
        html_content = '''<!DOCTYPE html>...'''
        with open('templates/index.html', 'w', encoding='utf-8') as f:
            f.write(html_content)
```

**è¯´æ˜**:
- `if __name__ == '__main__'` ç¡®ä¿åªæœ‰ç›´æ¥è¿è¡Œè„šæœ¬æ—¶æ‰æ‰§è¡Œ
- å¦‚æœé€šè¿‡importå¯¼å…¥ï¼Œè¿™éƒ¨åˆ†ä»£ç ä¸ä¼šæ‰§è¡Œ
- è‡ªåŠ¨åˆ›å»ºtemplatesç›®å½•å’ŒHTMLæ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰

#### æ­¥éª¤4: å¯åŠ¨WebæœåŠ¡å™¨

```python
app.run(host='0.0.0.0', port=8080, debug=False)
```

**è¯¦ç»†è¿‡ç¨‹**:

1. **åˆ›å»ºWSGIæœåŠ¡å™¨**:
   - Flaskå†…éƒ¨ä½¿ç”¨Werkzeugï¼ˆWSGIå·¥å…·åº“ï¼‰
   - åˆ›å»ºä¸€ä¸ªHTTPæœåŠ¡å™¨ç›‘å¬æŒ‡å®šç«¯å£

2. **ç»‘å®šç½‘ç»œæ¥å£**:
   - `host='0.0.0.0'`: ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
     - `0.0.0.0` è¡¨ç¤ºæ¥å—æ¥è‡ªä»»ä½•IPåœ°å€çš„è¿æ¥
     - `127.0.0.1` æˆ– `localhost` åªæ¥å—æœ¬æœºè¿æ¥
   - `port=8080`: ç›‘å¬8080ç«¯å£

3. **å¯åŠ¨ç›‘å¬å¾ªç¯**:
   ```python
   # Flaskå†…éƒ¨ä¼ªä»£ç 
   while True:
       # ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
       client_socket = accept_connection()
       
       # è§£æHTTPè¯·æ±‚
       request = parse_http_request(client_socket)
       
       # æ ¹æ®URLè·¯å¾„æŸ¥æ‰¾å¯¹åº”çš„å¤„ç†å‡½æ•°
       handler = find_route_handler(request.path)
       
       # è°ƒç”¨å¤„ç†å‡½æ•°ï¼Œè·å–å“åº”
       response = handler(request)
       
       # å‘é€HTTPå“åº”
       send_response(client_socket, response)
   ```

4. **è¾“å‡ºå¯åŠ¨ä¿¡æ¯**:
   ```
   * Running on http://0.0.0.0:8080
   * Press CTRL+C to quit
   ```

---

## 4. è·¯ç”±ç³»ç»Ÿ

### è·¯ç”±æ³¨å†Œæœºåˆ¶

Flaskä½¿ç”¨**è£…é¥°å™¨æ¨¡å¼**æ³¨å†Œè·¯ç”±ï¼š

```python
@app.route('/api/auto_label', methods=['POST'])
def auto_label():
    # å¤„ç†å‡½æ•°
    pass
```

**ç­‰ä»·äº**:
```python
def auto_label():
    pass

app.add_url_rule('/api/auto_label', 'auto_label', auto_label, methods=['POST'])
```

### è·¯ç”±åŒ¹é…è¿‡ç¨‹

å½“æµè§ˆå™¨å‘é€è¯·æ±‚ `http://localhost:8080/api/auto_label` æ—¶ï¼š

1. **è§£æURL**:
   - è·¯å¾„: `/api/auto_label`
   - æ–¹æ³•: `POST`

2. **æŸ¥æ‰¾è·¯ç”±**:
   - Flaskåœ¨å†…éƒ¨è·¯ç”±è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…çš„è§„åˆ™
   - æ‰¾åˆ° `@app.route('/api/auto_label', methods=['POST'])`

3. **è°ƒç”¨å¤„ç†å‡½æ•°**:
   - æ‰§è¡Œ `auto_label()` å‡½æ•°
   - ä¼ å…¥ `request` å¯¹è±¡

4. **è¿”å›å“åº”**:
   - å‡½æ•°è¿”å›å€¼è½¬æ¢ä¸ºHTTPå“åº”
   - å‘é€ç»™å®¢æˆ·ç«¯

### è·¯ç”±ç±»å‹

#### 1. é¡µé¢è·¯ç”±ï¼ˆè¿”å›HTMLï¼‰

```python
@app.route('/')
def index():
    return render_template('index.html')
```

- è¿”å›HTMLé¡µé¢
- æµè§ˆå™¨ç›´æ¥æ¸²æŸ“æ˜¾ç¤º

#### 2. APIè·¯ç”±ï¼ˆè¿”å›JSONï¼‰

```python
@app.route('/api/dataset_info')
def dataset_info():
    info = {
        'train_images': 100,
        'val_images': 20
    }
    return jsonify(info)
```

- è¿”å›JSONæ•°æ®
- å‰ç«¯é€šè¿‡AJAXè°ƒç”¨

#### 3. æ–‡ä»¶è·¯ç”±ï¼ˆè¿”å›æ–‡ä»¶ï¼‰

```python
@app.route('/api/get_file')
def get_file():
    file_path = request.args.get('path')
    return send_file(file_path)
```

- è¿”å›æ–‡ä»¶å†…å®¹
- ç”¨äºä¸‹è½½æˆ–æ˜¾ç¤ºæ–‡ä»¶

#### 4. æµå¼è·¯ç”±ï¼ˆSSEï¼‰

```python
@app.route('/api/pose_stream')
def pose_stream():
    def event_source():
        while True:
            data = q.get()
            yield f"data: {json.dumps(data)}\n\n"
    return Response(event_source(), mimetype='text/event-stream')
```

- è¿”å›æµå¼æ•°æ®
- ç”¨äºå®æ—¶æ¨é€

---

## 5. æ¨¡æ¿æ¸²æŸ“æœºåˆ¶

### ä»€ä¹ˆæ˜¯æ¨¡æ¿ï¼Ÿ

æ¨¡æ¿æ˜¯åŒ…å«å ä½ç¬¦çš„HTMLæ–‡ä»¶ï¼ŒFlaskå¯ä»¥åŠ¨æ€å¡«å……å†…å®¹ã€‚

### æ¨¡æ¿æŸ¥æ‰¾æœºåˆ¶

```python
return render_template('index.html')
```

**æŸ¥æ‰¾è¿‡ç¨‹**:

1. Flaské»˜è®¤åœ¨ `templates/` ç›®å½•ä¸‹æŸ¥æ‰¾æ¨¡æ¿æ–‡ä»¶
2. å®Œæ•´è·¯å¾„: `./templates/index.html`
3. å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¿”å›404é”™è¯¯

### æœ¬é¡¹ç›®ä¸­çš„æ¨¡æ¿ç”Ÿæˆ

**ç‰¹æ®Šä¹‹å¤„**: æœ¬é¡¹ç›®åœ¨ä»£ç ä¸­å†…åµŒHTMLï¼Œé¦–æ¬¡è¿è¡Œæ—¶è‡ªåŠ¨ç”Ÿæˆï¼š

```python
if not html_file.exists():
    html_content = '''
    <!DOCTYPE html>
    <html>
        <!-- å®Œæ•´çš„HTMLä»£ç  -->
    </html>
    '''
    with open('templates/index.html', 'w', encoding='utf-8') as f:
        f.write(html_content)
```

**ä¼˜ç‚¹**:
- ä¸éœ€è¦å•ç‹¬ç»´æŠ¤HTMLæ–‡ä»¶
- ä»£ç å’Œç•Œé¢åœ¨ä¸€èµ·ï¼Œä¾¿äºç®¡ç†
- é¦–æ¬¡è¿è¡Œè‡ªåŠ¨ç”Ÿæˆï¼Œåç»­å¯æ‰‹åŠ¨ä¿®æ”¹

---

## 6. å‰åç«¯äº¤äº’

### HTTPè¯·æ±‚-å“åº”æ¨¡å‹

```
æµè§ˆå™¨                    FlaskæœåŠ¡å™¨
  â”‚                          â”‚
  â”‚  GET /                   â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚ æŸ¥æ‰¾è·¯ç”±
  â”‚                          â”‚ è°ƒç”¨index()
  â”‚                          â”‚ è¯»å–index.html
  â”‚  HTTP 200 OK             â”‚
  â”‚  <!DOCTYPE html>...      â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                          â”‚
  â”‚  POST /api/auto_label    â”‚
  â”‚  {"img_dir": "..."}      â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚ è§£æJSON
  â”‚                          â”‚ è°ƒç”¨auto_label()
  â”‚                          â”‚ å¯åŠ¨åå°ä»»åŠ¡
  â”‚  HTTP 200 OK             â”‚
  â”‚  {"message": "å·²å¯åŠ¨"}   â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### AJAXå¼‚æ­¥è¯·æ±‚

**å‰ç«¯ä»£ç **:
```javascript
function startAutoLabel() {
    const data = {
        img_dir: document.getElementById('img_dir').value,
        model_path: document.getElementById('model_path').value,
    };
    
    fetch('/api/auto_label', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
        } else {
            showSuccess(data.message);
        }
    });
}
```

**åç«¯å¤„ç†**:
```python
@app.route('/api/auto_label', methods=['POST'])
def auto_label():
    data = request.json  # è§£æJSONè¯·æ±‚ä½“
    img_dir = data.get('img_dir')
    
    # å¤„ç†ä¸šåŠ¡é€»è¾‘
    # ...
    
    return jsonify({'message': 'ä»»åŠ¡å·²å¯åŠ¨'})  # è¿”å›JSONå“åº”
```

### æ•°æ®æµç¨‹

1. **ç”¨æˆ·æ“ä½œ**: ç‚¹å‡»"å¼€å§‹ä½å§¿æå–"æŒ‰é’®
2. **å‰ç«¯æ”¶é›†æ•°æ®**: JavaScriptæ”¶é›†è¡¨å•æ•°æ®
3. **å‘é€AJAXè¯·æ±‚**: `fetch()` å‘é€POSTè¯·æ±‚åˆ° `/api/auto_label`
4. **åç«¯æ¥æ”¶**: Flaskæ¥æ”¶è¯·æ±‚ï¼Œè§£æJSONæ•°æ®
5. **å¤„ç†ä¸šåŠ¡**: è°ƒç”¨ `auto_label_yolo_format()` å‡½æ•°
6. **è¿”å›å“åº”**: è¿”å›JSONæ ¼å¼çš„ç»“æœ
7. **å‰ç«¯æ›´æ–°**: JavaScriptæ›´æ–°é¡µé¢æ˜¾ç¤º

---

## 7. å®æ—¶é€šä¿¡æŠ€æœ¯

### Server-Sent Events (SSE)

SSEæ˜¯ä¸€ç§**æœåŠ¡å™¨ä¸»åŠ¨æ¨é€**æ•°æ®åˆ°å®¢æˆ·ç«¯çš„æŠ€æœ¯ã€‚

#### å·¥ä½œåŸç†

```
æµè§ˆå™¨                    FlaskæœåŠ¡å™¨
  â”‚                          â”‚
  â”‚  GET /api/pose_stream    â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚ åˆ›å»ºEventSource
  â”‚                          â”‚ è¿›å…¥å¾ªç¯
  â”‚                          â”‚
  â”‚  data: {...}\n\n         â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  æ¨é€æ•°æ®1
  â”‚                          â”‚
  â”‚  data: {...}\n\n         â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  æ¨é€æ•°æ®2
  â”‚                          â”‚
  â”‚  ... (æŒç»­æ¨é€)          â”‚
```

#### åç«¯å®ç°

```python
@app.route('/api/pose_stream')
def pose_stream():
    q = pose_stream_state['queue']  # å…±äº«é˜Ÿåˆ—
    
    @stream_with_context
    def event_source():
        while True:
            try:
                # ä»é˜Ÿåˆ—è·å–æ•°æ®
                item = q.get(timeout=0.5)
                
                # æ ¼å¼åŒ–ä¸ºSSEæ ¼å¼
                yield f"data: {json.dumps(item)}\n\n"
            except queue.Empty:
                continue
    
    # è¿”å›æµå¼å“åº”
    return Response(
        event_source(), 
        mimetype='text/event-stream',
        headers={
            'Cache-Control': 'no-cache',
            'Connection': 'keep-alive'
        }
    )
```

**å…³é”®ç‚¹**:
- `yield` å…³é”®å­—å®ç°ç”Ÿæˆå™¨ï¼Œå¯ä»¥æŒç»­äº§ç”Ÿæ•°æ®
- SSEæ ¼å¼: `data: {json}\n\n`ï¼ˆä¸¤ä¸ªæ¢è¡Œç¬¦è¡¨ç¤ºä¸€æ¡æ¶ˆæ¯ï¼‰
- `stream_with_context` ä¿æŒFlaskä¸Šä¸‹æ–‡

#### å‰ç«¯æ¥æ”¶

```javascript
// åˆ›å»ºEventSourceè¿æ¥
const eventSource = new EventSource('/api/pose_stream');

// ç›‘å¬æ¶ˆæ¯
eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);
    // æ›´æ–°é¡µé¢æ˜¾ç¤º
    updateDisplay(data);
};

// ç›‘å¬ç‰¹å®šäº‹ä»¶
eventSource.addEventListener('end', () => {
    eventSource.close();
});
```

#### æ•°æ®æµ

```
è§†é¢‘å¤„ç†çº¿ç¨‹         é˜Ÿåˆ—            SSEæµ          æµè§ˆå™¨
    â”‚                â”‚                â”‚              â”‚
    â”‚ æ£€æµ‹å…³é”®ç‚¹      â”‚                â”‚              â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚              â”‚
    â”‚                â”‚                â”‚              â”‚
    â”‚                â”‚ è·å–æ•°æ®       â”‚              â”‚
    â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
    â”‚                â”‚                â”‚ æ¨é€SSE      â”‚
    â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                â”‚                â”‚              â”‚ æ›´æ–°æ˜¾ç¤º
```

---

## 8. è¯·æ±‚å¤„ç†æµç¨‹

### å®Œæ•´è¯·æ±‚å¤„ç†ç¤ºä¾‹

ä»¥"ä½å§¿æå–"åŠŸèƒ½ä¸ºä¾‹ï¼š

#### 1. ç”¨æˆ·æ“ä½œ

ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­ï¼š
1. å¡«å†™è¡¨å•ï¼ˆå›¾ç‰‡ç›®å½•ã€æ¨¡å‹è·¯å¾„ç­‰ï¼‰
2. ç‚¹å‡»"å¼€å§‹ä½å§¿æå–"æŒ‰é’®

#### 2. å‰ç«¯å‘é€è¯·æ±‚

```javascript
fetch('/api/auto_label', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
        img_dir: './datasets/images/train',
        model_path: './models/yolov8n-pose.pt',
        output_dir: './datasets/labels/train',
        conf_threshold: 0.5
    })
})
```

#### 3. Flaskæ¥æ”¶è¯·æ±‚

```python
@app.route('/api/auto_label', methods=['POST'])
def auto_label():
    # Flaskè‡ªåŠ¨è§£æHTTPè¯·æ±‚
    # request.json åŒ…å«JSONæ•°æ®
    data = request.json
    img_dir = data.get('img_dir')
```

#### 4. å‚æ•°éªŒè¯

```python
if not os.path.exists(img_dir):
    return jsonify({'error': 'å›¾ç‰‡ç›®å½•ä¸å­˜åœ¨'}), 400
```

#### 5. å¯åŠ¨åå°ä»»åŠ¡

```python
def run_auto_label():
    # åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡Œ
    task_status['running'] = True
    auto_label_yolo_format(img_dir, model_path, output_dir, conf_threshold)
    task_status['running'] = False

thread = threading.Thread(target=run_auto_label)
thread.start()
```

**ä¸ºä»€ä¹ˆä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ**
- ä½å§¿æå–æ˜¯è€—æ—¶æ“ä½œï¼ˆå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰
- å¦‚æœåŒæ­¥æ‰§è¡Œï¼Œä¼šé˜»å¡HTTPè¯·æ±‚ï¼Œæµè§ˆå™¨ä¼šä¸€ç›´ç­‰å¾…
- ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œç«‹å³è¿”å›å“åº”ï¼Œä»»åŠ¡åœ¨åå°æ‰§è¡Œ

#### 6. ç«‹å³è¿”å›å“åº”

```python
return jsonify({'message': 'è‡ªåŠ¨æ ‡å®šä»»åŠ¡å·²å¯åŠ¨'})
```

- HTTPçŠ¶æ€ç : 200 OK
- å“åº”ä½“: `{"message": "è‡ªåŠ¨æ ‡å®šä»»åŠ¡å·²å¯åŠ¨"}`
- æµè§ˆå™¨ç«‹å³æ”¶åˆ°å“åº”ï¼Œæ˜¾ç¤º"ä»»åŠ¡å·²å¯åŠ¨"

#### 7. å‰ç«¯è½®è¯¢çŠ¶æ€

```javascript
function pollStatus() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            if (data.running) {
                // æ›´æ–°è¿›åº¦æ¡
                document.getElementById('progress-bar').style.width = data.progress + '%';
                // ç»§ç»­è½®è¯¢
                setTimeout(pollStatus, 1000);
            } else {
                // ä»»åŠ¡å®Œæˆ
                showStatus('success', data.message);
            }
        });
}
```

#### 8. åå°ä»»åŠ¡æ‰§è¡Œ

```python
def run_auto_label():
    # åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­æ‰§è¡Œ
    model = YOLO(model_path)
    for img_path in image_files:
        results = model(img_path, conf=conf_threshold)
        save_yolo_pose_txt_with_bbox(results, output_dir)
        # æ›´æ–°è¿›åº¦
        task_status['progress'] = current / total * 100
```

#### 9. ä»»åŠ¡å®Œæˆ

```python
task_status['progress'] = 100
task_status['message'] = 'è‡ªåŠ¨æ ‡å®šå®Œæˆï¼'
task_status['running'] = False
```

å‰ç«¯è½®è¯¢æ£€æµ‹åˆ° `running=False`ï¼Œæ˜¾ç¤ºå®Œæˆæ¶ˆæ¯ã€‚

---

## 9. ç½‘ç»œè®¿é—®åŸç†

### ä¸ºä»€ä¹ˆå¯ä»¥é€šè¿‡æµè§ˆå™¨è®¿é—®ï¼Ÿ

#### 1. HTTPåè®®

```
æµè§ˆå™¨è¾“å…¥: http://localhost:8080
           â”‚      â”‚         â”‚
           â”‚      â”‚         â””â”€ ç«¯å£å·
           â”‚      â””â”€ ä¸»æœºåï¼ˆæœ¬æœºï¼‰
           â””â”€ åè®®ï¼ˆè¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼‰
```

#### 2. TCPè¿æ¥

```
æµè§ˆå™¨                    FlaskæœåŠ¡å™¨
  â”‚                          â”‚
  â”‚  TCPè¿æ¥è¯·æ±‚             â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚ æ¥å—è¿æ¥
  â”‚  TCPè¿æ¥å»ºç«‹             â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚                          â”‚
  â”‚  HTTPè¯·æ±‚                â”‚
  â”‚  GET / HTTP/1.1          â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                          â”‚ å¤„ç†è¯·æ±‚
  â”‚  HTTPå“åº”                â”‚
  â”‚  HTTP/1.1 200 OK         â”‚
  â”‚  <!DOCTYPE html>...      â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

#### 3. ç«¯å£ç›‘å¬

```python
app.run(host='0.0.0.0', port=8080)
```

- Flaskåœ¨8080ç«¯å£ç›‘å¬è¿æ¥
- `0.0.0.0` è¡¨ç¤ºç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£
- æµè§ˆå™¨è¿æ¥åˆ° `localhost:8080` æ—¶ï¼ŒFlaskæ¥æ”¶è¿æ¥

#### 4. ä¸ºä»€ä¹ˆå…¶ä»–ç”µè„‘å¯ä»¥è®¿é—®ï¼Ÿ

```
å±€åŸŸç½‘è®¾å¤‡A               ä½ çš„ç”µè„‘               å±€åŸŸç½‘è®¾å¤‡B
    â”‚                      â”‚                      â”‚
    â”‚  http://192.168.1.100:8080                 â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
    â”‚                      â”‚ å¤„ç†è¯·æ±‚              â”‚
    â”‚                      â”‚ è¿”å›å“åº”              â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
    â”‚                      â”‚                      â”‚
    â”‚                      â”‚  http://192.168.1.100:8080
    â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                      â”‚ å¤„ç†è¯·æ±‚              â”‚
    â”‚                      â”‚ è¿”å›å“åº”              â”‚
    â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
```

**å…³é”®ç‚¹**:
- `host='0.0.0.0'` å…è®¸å¤–éƒ¨è¿æ¥
- å…¶ä»–è®¾å¤‡é€šè¿‡ä½ çš„IPåœ°å€è®¿é—®ï¼ˆå¦‚ `http://192.168.1.100:8080`ï¼‰
- æ‰€æœ‰è®¡ç®—ä»åœ¨ä½ çš„ç”µè„‘ä¸Šæ‰§è¡Œ

---

## 10. å…³é”®æŠ€æœ¯ç»†èŠ‚

### 10.1 å…¨å±€çŠ¶æ€ç®¡ç†

```python
# å…¨å±€å˜é‡å­˜å‚¨ä»»åŠ¡çŠ¶æ€
task_status = {
    'running': False,
    'progress': 0,
    'message': '',
    'logs': []
}
```

**ä¸ºä»€ä¹ˆä½¿ç”¨å…¨å±€å˜é‡ï¼Ÿ**
- Flaskæ˜¯å•è¿›ç¨‹åº”ç”¨ï¼Œæ‰€æœ‰è¯·æ±‚å…±äº«åŒä¸€ä¸ªè¿›ç¨‹
- å…¨å±€å˜é‡å¯ä»¥åœ¨ä¸åŒè¯·æ±‚ä¹‹é—´å…±äº«çŠ¶æ€
- ç®€å•ç›´æ¥ï¼Œé€‚åˆå•æœºéƒ¨ç½²

**æ³¨æ„**: å¤šè¿›ç¨‹éƒ¨ç½²æ—¶éœ€è¦ä½¿ç”¨æ•°æ®åº“æˆ–Redisç­‰å…±äº«å­˜å‚¨

### 10.2 å¤šçº¿ç¨‹å¤„ç†

```python
def worker():
    # é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡
    process_video()

thread = threading.Thread(target=worker, daemon=True)
thread.start()
```

**daemonçº¿ç¨‹**:
- `daemon=True`: ä¸»ç¨‹åºé€€å‡ºæ—¶ï¼Œçº¿ç¨‹è‡ªåŠ¨ç»ˆæ­¢
- é¿å…ç¨‹åºæ— æ³•æ­£å¸¸é€€å‡º

### 10.3 é˜Ÿåˆ—é€šä¿¡

```python
q = queue.Queue(maxsize=32)

# ç”Ÿäº§è€…ï¼ˆè§†é¢‘å¤„ç†çº¿ç¨‹ï¼‰
q.put(keypoint_data)

# æ¶ˆè´¹è€…ï¼ˆSSEæµï¼‰
data = q.get(timeout=0.5)
```

**ä½œç”¨**:
- è§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
- ç¼“å†²æ•°æ®ï¼Œå¹³è¡¡å¤„ç†é€Ÿåº¦å·®å¼‚
- çº¿ç¨‹å®‰å…¨çš„æ•°æ®äº¤æ¢

### 10.4 é”™è¯¯å¤„ç†

```python
try:
    result = process_data()
    return jsonify({'success': True, 'data': result})
except Exception as e:
    logging.error(f'å¤„ç†å¤±è´¥: {e}', exc_info=True)
    return jsonify({'error': str(e)}), 500
```

**HTTPçŠ¶æ€ç **:
- `200`: æˆåŠŸ
- `400`: å®¢æˆ·ç«¯é”™è¯¯ï¼ˆå‚æ•°é”™è¯¯ï¼‰
- `404`: èµ„æºä¸å­˜åœ¨
- `500`: æœåŠ¡å™¨é”™è¯¯

---

## 11. æ€»ç»“

### è¿è¡Œ `python web_app.py` çš„å®Œæ•´æµç¨‹

1. **åˆå§‹åŒ–é˜¶æ®µ**:
   - å¯¼å…¥Flaskå’Œæ‰€æœ‰æ¨¡å—
   - åˆ›å»ºFlaskåº”ç”¨å®ä¾‹
   - æ³¨å†Œæ‰€æœ‰è·¯ç”±

2. **å‡†å¤‡é˜¶æ®µ**:
   - è®¾ç½®æ—¥å¿—ç³»ç»Ÿ
   - åˆ›å»ºtemplatesç›®å½•
   - ç”ŸæˆHTMLæ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰

3. **å¯åŠ¨é˜¶æ®µ**:
   - å¯åŠ¨WSGIæœåŠ¡å™¨
   - ç›‘å¬ `0.0.0.0:8080`
   - ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥

4. **è¿è¡Œé˜¶æ®µ**:
   - æ¥æ”¶HTTPè¯·æ±‚
   - è·¯ç”±åŒ¹é…
   - è°ƒç”¨å¤„ç†å‡½æ•°
   - è¿”å›å“åº”
   - å¾ªç¯å¤„ç†ä¸‹ä¸€ä¸ªè¯·æ±‚

### æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹

- **Flaskæ¡†æ¶**: è½»é‡çº§Webæ¡†æ¶ï¼Œå¤„ç†HTTPè¯·æ±‚/å“åº”
- **è·¯ç”±ç³»ç»Ÿ**: URLè·¯å¾„æ˜ å°„åˆ°Pythonå‡½æ•°
- **æ¨¡æ¿æ¸²æŸ“**: åŠ¨æ€ç”ŸæˆHTMLé¡µé¢
- **AJAXé€šä¿¡**: å¼‚æ­¥è¯·æ±‚ï¼Œä¸åˆ·æ–°é¡µé¢
- **SSEæ¨é€**: æœåŠ¡å™¨ä¸»åŠ¨æ¨é€å®æ—¶æ•°æ®
- **å¤šçº¿ç¨‹**: åå°å¤„ç†è€—æ—¶ä»»åŠ¡
- **çŠ¶æ€ç®¡ç†**: å…¨å±€å˜é‡å…±äº«ä»»åŠ¡çŠ¶æ€

### è®¿é—®æµç¨‹

```
ç”¨æˆ·è¾“å…¥URL
    â†“
æµè§ˆå™¨è§£æURL
    â†“
å»ºç«‹TCPè¿æ¥
    â†“
å‘é€HTTPè¯·æ±‚
    â†“
Flaskæ¥æ”¶è¯·æ±‚
    â†“
è·¯ç”±åŒ¹é…
    â†“
è°ƒç”¨å¤„ç†å‡½æ•°
    â†“
è¿”å›HTTPå“åº”
    â†“
æµè§ˆå™¨æ¸²æŸ“é¡µé¢
```

---


